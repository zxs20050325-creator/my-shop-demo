<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è´­ç‰©è½¦</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'å¾®è½¯é›…é»‘'; }
        body { background: #f5f5f5; padding-top: 80px; }
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%;
            background: #333; color: white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        .nav-links a { color: white; text-decoration: none; margin-left: 20px; }
        
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .cart-header { display: flex; justify-content: space-between; align-items: center<!DOCTYPE html>
<HTML lang=â€œzh-CN">
<å¤´éƒ¨>
    <meta charset=â€œUTF-8">
    <Meta name=â€œviewportâ€ å†…å®¹=â€œwidth=device-widthï¼Œ initial-scale=1.0">
    <title>å†€é—ç­‘æ¢¦ - äº‘ç«¯å•†åŸ</title>
    <é£æ ¼>
        * { ä¼˜åŠ¿ï¼š0;ç¼“å†²ï¼š0;ç›’å­å°ºå¯¸ï¼šè¾¹æ¡†ç›’;font-familyï¼š 'å¾®è½¯é›…é»‘'; }
        èº«ä½“ { èƒŒæ™¯ï¼š#F5F5f5;å«å±‚é¡¶å±‚ï¼š80åƒç´ ; }
.å¯¼èˆªæ  {
            ä½ç½®ï¼šå›ºå®š;é¡¶éƒ¨ï¼š0;å·¦ï¼š0;å®½åº¦ï¼š100%;
            èƒŒæ™¯ï¼š#8B2A2A;/* æ”¹æˆæ•…å®«çº¢/ç –çº¢è‰²ï¼Œç¬¦åˆä¸»é¢˜ */
            èƒŒæ™¯ï¼š#8B2A2A; 
            é¢œè‰²ï¼šç™½è‰²;ç¼“å†²ï¼š15px 30px;
            æ˜¾ç¤ºï¼šflex;æ­£å½“åŒ–å†…å®¹ï¼šç©ºé—´ä¹‹é—´çš„;å¯¹é½ç‰©å“ï¼šä¸­å¿ƒ;ZæŒ‡æ•°ï¼š1000;
            ç›’å­-å½±å­ï¼š0 2px 10px RGBAï¼ˆ0,0,0,0.2);
@@ -19,7 +19,6 @@

.å®¹å™¨ { æœ€å¤§å®½åº¦ï¼š1200px;å‡€èƒœç‡ï¼š0 è‡ªåŠ¨;å¡«å……ç‰©ï¼š20px; }

        /* æ ‡é¢˜æ ·å¼ */
.page-title { text-alignï¼š center;è¾¹ç¼˜-åº•éƒ¨ï¼š30px;é¢œè‰²ï¼š#333; }
.é¡µæ ‡é¢˜ H2 { å­—ä½“å¤§å°ï¼š32px;å­—ä½“ç²—å¤§ï¼šåŠ ç²—;åˆ©æ¶¦ç‡åº•çº¿ï¼š10px; }
.é¡µå P { é¢œè‰²ï¼š#666;å­—ä½“å¤§å°ï¼š16px; }
@@ -33,157 +32,165 @@
        }
.product-cardï¼šhover { transformï¼š translateYï¼ˆ-5pxï¼‰;ç›’å½±ï¼š0 8px 20px RGBAï¼ˆ0,0,0,0.15 ); }

.product-img { å®½åº¦ï¼š 100%;èº«é«˜ï¼š220px;ç‰©ä½“é€‚é…ï¼šæ©æŠ¤;}
        /* ============== ä¿®æ”¹é‡ç‚¹ ============== */
.product-img { 
            å®½åº¦ï¼š100%; 
            é«˜åº¦ï¼š250px;/* ç¨å¾®åŠ é«˜äº†ä¸€ç‚¹é«˜åº¦ï¼Œè®©ç«–ç€çš„å•†å“æ›´å¥½çœ‹ */
            å¯¹è±¡æ‹Ÿåˆï¼šåŒ…å«;/* ã€å…³é”®ä¿®æ”¹ã€‘æ”¹ä¸º containï¼Œå›¾ç‰‡ä¼šå®Œæ•´æ˜¾ç¤ºï¼Œä¸ä¼šè¢«è£å‰ª */
            èƒŒæ™¯è‰²ï¼š#FFF;/* èƒŒæ™¯è®¾ä¸ºç™½è‰²ï¼Œé˜²æ­¢å›¾ç‰‡æ¯”ä¾‹ä¸åŒæ—¶å‡ºç°ç°è¾¹ */
            æŠ¤å«ï¼š10px;/* ç»™å›¾ç‰‡ä¸€ç‚¹ç•™ç™½ï¼Œçœ‹èµ·æ¥æ›´ç²¾è‡´ */
        }
        /* ==================================== */

.å¡ç‰‡æœ¬ä½“ { å¡«å……ï¼š20px; }
.äº§å“åç§° { å­—ä½“å¤§å°ï¼š18px;å­—ä½“ç²—å¤§ï¼šåŠ ç²—;è¾¹ç¼˜-åº•éƒ¨ï¼š8px;é¢œè‰²ï¼š#333; }
.äº§å“ä»·æ ¼ { é¢œè‰²ï¼š#8B2A2A;å­—ä½“å¤§å°ï¼š22px;å­—ä½“ç²—å¤§ï¼šåŠ ç²—;åˆ©æ¶¦ç‡åº•çº¿ï¼š10px; }
.äº§å“æè¿° { é¢œè‰²ï¼š#666;å­—ä½“å¤§å°ï¼š14px;çº¿é«˜ï¼š1.5;è¾¹ç¼˜-åº•éƒ¨ï¼š15px;èº«é«˜ï¼š42è‹±å°º;æº¢å‡ºï¼šéšè—;æ–‡æœ¬æº¢å‡ºï¼šçœç•¥å·;æ˜¾ç¤ºï¼š-webkit-box;-ç½‘å½¢å¥—ä»¶çº¿å¤¹ï¼š2;-webkit-box-orientï¼šå‚ç›´;}

.BTN-ä¹° { 
            å®½åº¦ï¼š100%;ç¼“å†²ï¼š10px; 
            èƒŒæ™¯ï¼š#8B2A2A;é¢œè‰²ï¼šç™½è‰²;
            è¾¹ç•Œï¼šæ— ;è¾¹ç•ŒåŠå¾„ï¼š5px;å…‰æ ‡ï¼šæŒ‡é’ˆ;å­—ä½“å¤§å°ï¼š16px; 
        }
.BTN-buyï¼šhover { èƒŒæ™¯ï¼š#A53F3f; }

.é¡µç  { æ–‡æœ¬å¯¹é½ï¼šä¸­å¿ƒ;åˆ©æ¶¦ç‡ä¸Šé™ï¼š40px; }
.page-btn { å¡«å……ï¼š8px 20px;è¾¹é™…ï¼š0 5px;èƒŒæ™¯ï¼šç™½äºº;è¾¹æ¡†ï¼š1px å®å¿ƒ #ddd;å…‰æ ‡ï¼šæŒ‡é’ˆ;}
.Page-BTN:å·²å¤±æ•ˆ { èƒŒæ™¯: #å‘ƒ; å…‰æ ‡:ä¸å…è®¸;}
.é¡µç ä¿¡æ¯ { è¾¹è·ï¼š0 15px;é¢œè‰²ï¼š#666; }
    </é£æ ¼>
</å¤´éƒ¨>
<èº«ä½“>

    <å¯¼èˆªç±»åˆ«=â€œå¯¼èˆªæ ">
        <div style=â€œfont-sizeï¼š 22px; font-weightï¼š borgan;font-familyï¼š 'æ¥·ä½“';â€> ğŸ›ï¸ å†€é—ç­‘æ¢¦</div>
        <div class=â€œnav-linksâ€ id=â€œauth-section">
            <!-- JSå¡«å…… -->
        </åˆ†åŒº>
    </å¯¼èˆª>

    <div class=â€œcontainer">
        <div class=â€œé¡µé¢æ ‡é¢˜">
            <h2>ä¼ æ‰¿éé— Â·ç­‘æ¢¦æ²³åŒ—</h2>
            <p>ç²¾é€‰ç‡•èµµå¤§åœ°æ–‡åŒ–ç‘°å®</p>
        </åˆ†åŒº>

        <div class=â€œproduct-gridâ€ id=â€œproduct-listâ€></div>

        <div ç±»=â€œåˆ†é¡µâ€">
            <button class=â€œpage-btnâ€ id=â€œprev-btnâ€ onclick=â€œchangePageï¼ˆ-1ï¼‰â€>ä¸Šä¸€é¡µ</button>
            <span class=â€œpage-infoâ€ id=â€œpage-infoâ€>ç¬¬ 1 é¡µ</span>
            <button class=â€œpage-btnâ€ id=â€œnext-btnâ€ onclick=â€œchangePageï¼ˆ1ï¼‰â€>ä¸‹ä¸€é¡µ</button>
        </åˆ†åŒº>
    </åˆ†åŒº>

    <å‰§æœ¬>
        API_BASE  = ''; 
        ä»¤currentPage = 1;
        è®© productsCache = []; 

        çª—æˆ·ã€‚onload = å‡½æ•°() {
            checkLoginçŠ¶æ€();
            loadProductsï¼ˆcurrentPageï¼‰);
            trackUserActionï¼ˆ'è®¿é—®é¦–é¡µ'ï¼Œ 'æµè§ˆå•†å“åˆ—è¡¨');
        };

        function checkLoginStatus() {
            const user = localStorageã€‚getItemï¼ˆ'currentUser');
            const authSection = document.getElementByIdï¼ˆ'auth-section');
            å¦‚æœï¼ˆç”¨æˆ·ï¼‰) {
                authSectionã€‚innerHTML = `
<span>æ¬¢è¿ï¼Œ${user}</span>
<a href=â€œcart.htmlâ€> ğŸ›’ è´­ç‰©è½¦</a>
<a onclick=â€œlogoutï¼ˆï¼‰â€>é€€å‡º</a>
                `;
            } å¦åˆ™ {
                authSectionã€‚innerHTML = `
<a href=â€œlogin.htmlâ€>ç™»å½•</a>
<a href=â€œregister.htmlâ€>æ³¨å†Œ</a>
                `;
            }
        }

        åŠŸèƒ½ç™»å‡º() {
            trackUserActionï¼ˆ'ç”¨æˆ·ç™»å‡º'ï¼Œ '-');
            localStorageã€‚removeItemï¼ˆ'currentUser');
            çª—æˆ·ã€‚ä½ç½®ã€‚é‡æ–°è£…å¡«();
        }

        async å‡½æ•° loadProductsï¼ˆpage) {
            è¯•è¯•çœ‹ {
                const res = await fetchï¼ˆ'${API_BASE}/API/productsï¼Ÿpage=${page}');
                const data = ç­‰å¾… res.JSON();
                productsCache = æ•°æ®ã€‚ç‰©å“; 

                const productList = document.getElementById('product-list');
                äº§å“åˆ—è¡¨ã€‚innerHTML = ''; 

                æ•°æ®ã€‚ç‰©å“ã€‚forEachï¼ˆï¼ˆproductï¼Œ indexï¼‰) => {
                    äº§å“åˆ—è¡¨ã€‚innerHTML += `
<div class=â€œproduct-cardâ€>
<img src=â€œ${product.img}â€œ class=â€product-imgâ€œ onerror=â€this.src='httpsï¼š//placehold.co/300x200ï¼Ÿtext=No+Image'â€œ>
<div class=â€œcard-bodyâ€>
<div class=â€œproduct-nameâ€>${product.name}</div>
<div class=â€œproduct-priceâ€>Â¥${product.ä»·æ ¼}</åˆ†>
<div class=â€œproduct-descâ€>${product.desc}</div>
<button class=â€œbtn-buyâ€ onclick=â€œaddToCartï¼ˆ${index}ï¼‰â€>åŠ å…¥è´­ç‰©è½¦</button>
</div>
</div>
                    `;
                });

                è®°å½•ã€‚getElementByIdï¼ˆ'page-info'ï¼‰ï¼‰ã€‚innerText = 'ç¬¬ ${data.page} é¡µ / å…± ${data.totalPages} é¡µ';
                è®°å½•ã€‚getElementByIdï¼ˆ'prev-btn'ï¼‰ã€‚disabled = æ•°æ®ã€‚é¡µé¢ <= 1;
                è®°å½•ã€‚getElementByIdï¼ˆ'next-btn'ï¼‰ã€‚disabled = æ•°æ®ã€‚é¡µé¢>= æ•°æ®ã€‚totalPagesï¼ˆå…¨é¡µï¼‰;
                currentPage = æ•°æ®ã€‚é¡µé¢;
            } æ¥ï¼ˆå‘ƒï¼‰{æ§åˆ¶å°ã€‚é”™è¯¯ï¼ˆerr); }
        }

        function changePageï¼ˆstepï¼‰) {
            loadProductsï¼ˆcurrentPage + step);
            trackUserActionï¼ˆ'ç¿»é¡µæµè§ˆ'ï¼Œ 'ç¬¬ ${currentPage + step} é¡µ');
        }

        async å‡½æ•° addToCartï¼ˆindex) {
            const user = localStorageã€‚getItemï¼ˆ'currentUser');
            å¦‚æœï¼ˆï¼ç”¨æˆ·) {
                alertï¼ˆ'è¯·å…ˆç™»å½•åå†è´­ä¹°ï¼');
                çª—æˆ·ã€‚ä½ç½®ã€‚href = 'login.html';
                å›å½’;
            }

            const product = productsCache[index];
            è¯•è¯•çœ‹ {
                const res = waitit fetchï¼ˆ'/api/cart/add'ï¼Œ {
                    æ–¹æ³•ï¼šâ€œPOSTâ€ï¼Œ
                    å¤´éƒ¨ï¼š { 'Content-Type'ï¼š 'application/json' }ï¼Œ
                    æ­£æ–‡ï¼šJSONã€‚Stringifyï¼ˆ{ ç”¨æˆ·åï¼šç”¨æˆ·ï¼Œäº§å“ï¼šäº§å“ })
                });
                const data = ç­‰å¾… res.JSON();
                ifï¼ˆdata.æˆåŠŸ) {
                    è­¦æŠ¥ï¼ˆ' âœ… [${product.name}] å·²åŠ å…¥è´­ç‰©è½¦ï¼');
                }
            } æ•æ‰ï¼ˆe) {
                alertï¼ˆ'æ·»åŠ å¤±è´¥');
            }
        }

        async function trackUserAction(action, product) {
            const currentUser = localStorage.getItem('currentUser') || 'æœªç™»å½•æ¸¸å®¢';
            è¯•è¯•çœ‹ {
                await fetch('/api/track', {
                    æ–¹æ³•ï¼šâ€œPOSTâ€ï¼Œ
                    å¤´éƒ¨ï¼š { 'Content-Type'ï¼š 'application/json' }ï¼Œ
                    body: JSON.stringify({
                        ç”¨æˆ·åï¼šcurrentUserï¼Œ
                        action: action,
                        product: product
                    })
                });
            } catch (e) {}
        }
    </å‰§æœ¬>
</èº«ä½“>
</html>; margin-bottom: 20px; }
        
        .cart-item { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cart-img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; margin-right: 20px; }
        .cart-info { flex: 1; }
        .cart-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .cart-price { color: #e63946; font-size: 18px; }
        .btn-remove { padding: 5px 15px; background: #ff4757; color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        .checkout-bar { background: white; padding: 20px; border-radius: 10px; text-align: right; margin-top: 20px; font-size: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .total-price { color: #e63946; font-weight: bold; font-size: 24px; margin: 0 10px; }
        .btn-checkout { padding: 10px 30px; background: #2ecc71; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; }
        .btn-checkout:hover { background: #27ae60; }

        .empty-cart { text-align: center; margin-top: 50px; color: #7f8c8d; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div style="font-size: 20px; font-weight: bold;">ğŸ›’ è´­ç‰©è½¦</div>
        <div class="nav-links">
            <a href="index.html">ç»§ç»­è´­ç‰©</a>
        </div>
    </nav>

    <div class="container">
        <div class="cart-header">
            <h2>è´­ç‰©æ¸…å•</h2>
            <span id="user-display"></span>
        </div>

        <div id="cart-list">
            <!-- è´­ç‰©è½¦åˆ—è¡¨ JS å¡«å…… -->
        </div>

        <div class="checkout-bar" id="checkout-bar" style="display:none;">
            æ€»è®¡: <span class="total-price" id="total-price">Â¥0</span>
            <button class="btn-checkout" onclick="checkout()">ç«‹å³ç»“ç®—</button>
        </div>
    </div>

    <script>
        const user = localStorage.getItem('currentUser');
        let currentCart = [];

        window.onload = function() {
            if(!user) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('user-display').innerText = `ç”¨æˆ·: ${user}`;
            loadCart();
        }

        async function loadCart() {
            try {
                const res = await fetch(`/api/cart?username=${user}`);
                currentCart = await res.json();
                renderCart();
            } catch(e) { console.error(e); }
        }

        function renderCart() {
            const listDiv = document.getElementById('cart-list');
            const checkoutBar = document.getElementById('checkout-bar');
            
            if(currentCart.length === 0) {
                listDiv.innerHTML = '<div class="empty-cart"><h3>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ ğŸ’¨</h3><p>å¿«å»é¦–é¡µé€‰è´­å–œæ¬¢çš„å•†å“å§ï¼</p></div>';
                checkoutBar.style.display = 'none';
                return;
            }

            listDiv.innerHTML = '';
            let total = 0;

            currentCart.forEach((item, index) => {
                total += item.price;
                listDiv.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.img}" class="cart-img">
                        <div class="cart-info">
                            <div class="cart-title">${item.name}</div>
                            <div class="cart-price">Â¥${item.price}</div>
                        </div>
                        <button class="btn-remove" onclick="removeItem(${index})">åˆ é™¤</button>
                    </div>
                `;
            });

            document.getElementById('total-price').innerText = `Â¥${total}`;
            checkoutBar.style.display = 'block';
        }

        async function removeItem(index) {
            if(!confirm('ç¡®å®šç§»é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) return;
            
            await fetch('/api/cart/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, index: index })
            });
            loadCart(); // åˆ·æ–°åˆ—è¡¨
        }

        async function checkout() {
            const total = document.getElementById('total-price').innerText;
            if(!confirm(`ç¡®è®¤æ”¯ä»˜ ${total} å—ï¼Ÿ`)) return;

            // è°ƒç”¨ç»“è´¦æ¥å£
            await fetch('/api/cart/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, totalPrice: total.replace('Â¥', '') })
            });

            alert('ğŸ‰ æ”¯ä»˜æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼');
            loadCart(); // åˆ·æ–°ï¼ˆæ¸…ç©ºï¼‰
        }
    </script>
</body>
</html>

