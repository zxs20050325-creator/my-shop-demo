<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶é“¶å° - å†€é—ç­‘æ¢¦</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
        }
        
        body { 
            background: #fafafa; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }
        
        .pay-card { 
            background: white; 
            width: 400px; 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); 
            text-align: center;
            border: 1px solid #f0f0f0;
        }
        
        .header { 
            border-bottom: 1px solid #f5f5f5; 
            padding-bottom: 25px; 
            margin-bottom: 25px; 
        }
        
        .logo { 
            font-size: 22px; 
            font-weight: 600; 
            color: #8b2a2a; 
            margin-bottom: 5px; 
        }
        
        .amount-title { 
            color: #666; 
            font-size: 15px; 
        }
        
        .amount { 
            font-size: 36px; 
            font-weight: 600; 
            color: #333; 
            margin: 10px 0; 
        }
        
        .qrcode-box { 
            background: #fafafa; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            border: 1px dashed #e0e0e0;
        }
        
        .qrcode-img { 
            width: 200px; 
            height: 200px; 
            object-fit: contain; 
        }
        
        .tips { 
            font-size: 14px; 
            color: #666; 
            margin-top: 15px; 
        }
        
        .payment-instruction {
            font-size: 13px; 
            color: #8b2a2a; 
            margin-top: 8px; 
        }
        
        .btn-group { 
            display: flex; 
            gap: 12px; 
        }
        
        .btn { 
            flex: 1; 
            padding: 14px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-confirm { 
            background: #07c160; 
            color: white; 
        }
        
        .btn-confirm:hover { 
            background: #06ad56; 
        }
        
        .btn-cancel { 
            background: #f5f5f5; 
            color: #666; 
        }
        
        .btn-cancel:hover { 
            background: #eee; 
        }
    </style>
</head>
<body>
    <div class="pay-card">
        <div class="header">
            <div class="logo">ğŸ›ï¸ å†€é—ç­‘æ¢¦ Â· æ”¶é“¶å°</div>
            <div class="amount-title">è®¢å•æ€»é¢</div>
            <div class="amount" id="display-amount">Â¥0.00</div>
        </div>

        <div class="qrcode-box">
            <img src="" id="qr-code" class="qrcode-img" alt="æ”¯ä»˜äºŒç»´ç ">
            <div class="tips">è¯·ä½¿ç”¨ å¾®ä¿¡ æ‰«ç æ”¯ä»˜</div>
            <div class="payment-instruction">(æ‰«ç åè¯·è¾“å…¥å¯¹åº”é‡‘é¢è½¬è´¦)</div>
        </div>

        <div class="btn-group">
            <button class="btn btn-cancel" onclick="history.back()">å–æ¶ˆ</button>
            <button class="btn btn-confirm" onclick="finishPayment()">æˆ‘å·²æ”¯ä»˜</button>
        </div>
    </div>

    <script>
        // 1. è·å–ç½‘å€é‡Œä¼ è¿‡æ¥çš„é‡‘é¢
        const params = new URLSearchParams(window.location.search);
        const money = params.get('money');
        const user = localStorage.getItem('currentUser');

        // 2. åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            if(!money || !user) {
                alert('è®¢å•æ— æ•ˆ');
                window.location.href = 'index.html';
                return;
            }
            
            // æ˜¾ç¤ºé‡‘é¢
            document.getElementById('display-amount').innerText = `Â¥${money}`;
            
            // ================= å…³é”®ä¿®æ”¹åœ¨è¿™é‡Œ =================
            // æŒ‡å‘ä½ åœ¨ images æ–‡ä»¶å¤¹é‡Œä¸Šä¼ çš„ wx-pay.jpg
            document.getElementById('qr-code').src = '/images/wx-pay.jpg'; 
            // ================================================
        };

        // 3. ç‚¹å‡»"æˆ‘å·²æ”¯ä»˜"
        async function finishPayment() {
            try {
                // è°ƒç”¨åç«¯çš„ã€ç»“è´¦æ¥å£ã€‘
                const res = await fetch('/api/cart/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: user, 
                        totalPrice: money 
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('ğŸ‰ æ”¯ä»˜æˆåŠŸï¼æ„Ÿè°¢æ‚¨æ”¯æŒéé—æ–‡åŒ–ï¼');
                    window.location.href = 'index.html'; // æ”¯ä»˜å®Œå›é¦–é¡µ
                } else {
                    alert('æ”¯ä»˜å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (err) {
                console.error(err);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }
    </script>
</body>
</html>