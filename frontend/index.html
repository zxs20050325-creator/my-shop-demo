<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>冀遗筑梦 | 数字化分析平台</title>
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<style>
:root {
    --c-primary: #2F4842; --c-accent: #C1A268; --c-bg: #F2F0EB;
    --c-grid: #E0DED9; --c-text-light: #8A9A96;
    --f-serif: 'Noto Serif SC', serif; --f-mono: 'Courier New', monospace;
    --sidebar-width: 80px; --img-fade-duration: 1.5s; --img-delay-step: 0.5s;
}
/* [效果2] 简约水墨光标 */
body { cursor: none !important; }
a, button, .dynasty-mark, .product-card, .search-btn, .page-num { cursor: none !important; }
#cursor-ink-dot { width: 6px; height: 6px; background: var(--c-primary); position: fixed; pointer-events: none; border-radius: 50%; z-index: 10001; }
#cursor-ink-wash { width: 20px; height: 20px; background: rgba(47, 72, 66, 0.1); position: fixed; pointer-events: none; border-radius: 50%; z-index: 10000; display: flex; justify-content: center; align-items: center; transition: width 0.5s cubic-bezier(0.16, 1, 0.3, 1), height 0.5s cubic-bezier(0.16, 1, 0.3, 1), background 0.5s, filter 0.5s; filter: blur(2px); }
.ink-stain-active { width: 45px !important; height: 45px !important; background: radial-gradient(circle, rgba(193, 162, 104, 0.25) 0%, transparent 80%) !important; filter: blur(3px) !important; border: 1px solid rgba(193, 162, 104, 0.2); }

* { margin: 0; padding: 0; box-sizing: border-box; }
body { background-color: var(--c-bg); color: var(--c-primary); font-family: var(--f-serif); overflow-x: hidden; background-image: linear-gradient(var(--c-grid) 1px, transparent 1px), linear-gradient(90deg, var(--c-grid) 1px, transparent 1px); background-size: 40px 40px; }
a { text-decoration: none; color: inherit; }
.p-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transform: translateY(20px); transition: opacity var(--img-fade-duration) ease-out, transform var(--img-fade-duration) ease-out; }
.p-img.fade-in { opacity: 1; transform: translateY(0); }

/* [效果4] 品牌名突出 */
.sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: #fff; border-right: 1px solid var(--c-primary); display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 40px 0; z-index: 1000; }
.brand-vertical { writing-mode: vertical-rl; font-size: 26px; font-weight: 900; letter-spacing: 12px; color: var(--c-primary); border: 2px solid var(--c-primary); padding: 30px 10px; position: relative; background: linear-gradient(to bottom, #fff, rgba(193, 162, 104, 0.05)); }
.brand-vertical::after { content: ''; position: absolute; bottom: 10px; left: 50%; width: 10px; height: 10px; background: #C12C1F; transform: translateX(-50%); box-shadow: 0 0 5px rgba(193, 44, 31, 0.3); }

.time-ruler { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 40px; position: relative; }
.time-ruler::before { content: ''; position: absolute; top: 20px; bottom: 20px; left: 50%; width: 1px; background: var(--c-grid); transform: translateX(-50%); }
.dynasty-mark { font-family: var(--f-mono); font-size: 12px; background: #fff; padding: 4px; z-index: 2; transition: 0.3s; color: var(--c-text-light); }
.dynasty-mark.active { color: var(--c-primary); font-weight: bold; transform: scale(1.2); }
.social-links i { display: block; margin-top: 20px; opacity: 0.5; transition: 0.3s; }
.social-links i:hover { opacity: 1; transform: translateY(-3px); }

.main-wrapper { margin-left: var(--sidebar-width); min-height: 100vh; display: grid; grid-template-columns: 240px 1fr; grid-template-areas: "top-bar top-bar" "hero hero" "filter content"; }
.top-bar { grid-area: top-bar; padding: 30px 60px; display: flex; justify-content: flex-end; align-items: center; gap: 40px; }
.search-minimal { display: flex; align-items: center; border-bottom: 1px solid var(--c-primary); padding-bottom: 5px; }
.search-minimal input { background: transparent; border: none; outline: none; width: 150px; font-family: var(--f-mono); text-align: right; }
.user-actions { font-family: var(--f-mono); font-size: 12px; margin-left: 20px; display: flex; gap: 20px; }

/* [效果3] 视差大字强化 */
.hero-section { grid-area: hero; padding: 40px 60px 80px; position: relative; height: 500px; display: flex; align-items: center; overflow: hidden; }
.big-typo { position: absolute; font-size: 25vw; font-weight: 900; color: rgba(47, 72, 66, 0.08); z-index: 0; top: -30px; left: -20px; pointer-events: none; line-height: 1; transition: transform 0.2s cubic-bezier(0.1, 0.5, 0.2, 1); }
.hero-card { display: flex; align-items: center; gap: 60px; z-index: 10; width: 100%; }
.hero-image-box { position: relative; width: 400px; height: 400px; }
.hero-image-box::before { content: ''; position: absolute; top: -20px; left: -20px; width: 100%; height: 100%; border: 1px solid var(--c-accent); z-index: -1; }
.hero-img { width: 100%; height: 100%; object-fit: cover; filter: saturate(0.8); transition: 0.5s; }
.hero-text h1 { font-size: 42px; margin-bottom: 10px; }
.btn-structural { padding: 12px 30px; background: var(--c-primary); color: #fff; border: none; font-family: var(--f-mono); transition: 0.3s; }
.btn-structural:hover { background: var(--c-accent); padding-left: 40px; }

/* [效果1] 3D 倾斜旋转增强 */
.filter-panel { grid-area: filter; padding: 40px; border-right: 1px dashed var(--c-grid); position: sticky; top: 0; height: 100vh; }
.filter-list button { display: block; width: 100%; text-align: left; background: none; border: none; padding: 10px 0; transition: 0.3s; position: relative; }
.filter-list button.active { color: var(--c-primary); font-weight: bold; padding-left: 15px; }
.filter-list button.active::before { content: ''; position: absolute; left: 0; top: 50%; width: 6px; height: 6px; background: var(--c-accent); transform: translateY(-50%) rotate(45deg); }

.content-panel { grid-area: content; padding: 40px 60px; }
.product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 40px; perspective: 1000px; }
.product-card { background: transparent; position: relative; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
.p-image-wrap { height: 320px; background: #fff; position: relative; overflow: hidden; border: 1px solid transparent; transition: 0.3s; transform: translateZ(25px); }
.product-card:hover .p-image-wrap { border-color: var(--c-accent); box-shadow: 15px 15px 0 rgba(44, 74, 71, 0.05); }
.p-tag { position: absolute; top: 0; left: 0; background: var(--c-primary); color: #fff; font-size: 10px; padding: 4px 8px; z-index: 10; }
.p-blindbox-tag { position: absolute; top: 0; right: 0; background: var(--c-accent); color: #fff; font-size: 12px; padding: 4px 8px; writing-mode: vertical-rl; z-index: 10; }
.p-info { margin-top: 15px; display: flex; justify-content: space-between; align-items: flex-end; transform: translateZ(40px); }
.p-price { color: var(--c-accent); font-weight: bold; font-family: var(--f-mono); }
.btn-add-cart { margin-top: 10px; width: 100%; padding: 8px; background: #fff; border: 1px solid var(--c-primary); font-size: 12px; opacity: 0; transform: translateY(10px); transition: 0.3s; }
.product-card:hover .btn-add-cart { opacity: 1; transform: translateY(0); }

.progress-indicator { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: var(--c-accent); z-index: 1001; }
.floating-cart { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--c-primary); color: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 1000; }
.cart-count { position: absolute; top: -5px; right: -5px; background: #ff4757; color: #fff; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; display: flex; justify-content: center; align-items: center; }

@media (max-width: 768px) {
    body { cursor: auto !important; } #cursor-ink-dot, #cursor-ink-wash { display: none; }
    .sidebar { display: none; } .main-wrapper { margin-left: 0; grid-template-columns: 1fr; grid-template-areas: "top-bar" "hero" "filter" "content"; }
    .filter-panel { position: static; height: auto; display: flex; overflow-x: auto; padding: 20px; border-bottom: 1px solid #ddd; }
}
</style>
</head>
<body>
<div id="cursor-ink-dot"></div><div id="cursor-ink-wash"></div>
<div class="progress-indicator" id="progressIndicator"></div>
<div class="floating-cart" onclick="window.location.href='cart.html'"><i class="fa fa-shopping-cart"></i><div class="cart-count" id="floatingCartCount">0</div></div>
<aside class="sidebar">
    <div class="brand-vertical">冀遗筑梦</div>
    <div class="time-ruler"><div class="dynasty-mark">SUI</div><div class="dynasty-mark active">TANG</div><div class="dynasty-mark">SONG</div><div class="dynasty-mark">MING</div><div class="dynasty-mark">QING</div></div>
    <div class="social-links"><i class="fa fa-weixin"></i><i class="fa fa-weibo"></i></div>
</aside>
<div class="main-wrapper">
    <header class="top-bar">
        <div class="search-minimal"><input type="text" id="search-input" placeholder="SEARCH..." onkeypress="if(event.key==='Enter')performSearch()"><button onclick="performSearch()" style="background:none;border:none;margin-left:10px;"><i class="fa fa-search"></i></button></div>
        <div class="user-actions" id="auth-section"></div>
    </header>
    <section class="hero-section" id="heroRegion">
        <div class="big-typo" id="heroTypo">筑梦</div>
        <div class="hero-card">
            <div class="hero-image-box"><img src="https://picsum.photos/id/1040/800/800" class="hero-img"></div>
            <div class="hero-text"><h1>正定隆兴寺·摩尼殿</h1><div style="color:var(--c-accent);font-family:var(--f-mono);margin-bottom:20px;">LONGXING TEMPLE SERIES</div><p>东方美学巅峰之作。结合3D打印技术，数字化复刻千年木构。</p><button class="btn-structural" onclick="window.scrollTo({top: 800, behavior: 'smooth'})">EXPLORE 探索结构</button></div>
        </div>
    </section>
    <aside class="filter-panel">
        <div class="filter-list" id="category-filters">
            <button class="active" onclick="filterProducts('all')">全部 / ALL</button>
            <button onclick="filterProducts('工艺品')">工艺 / CRAFT</button>
            <button onclick="filterProducts('剪纸')">剪纸 / PAPER</button>
            <button onclick="filterProducts('雕刻')">雕刻 / CARVING</button>
            <button onclick="filterProducts('陶瓷')">陶瓷 / CERAMIC</button>
        </div>
    </aside>
    <main class="content-panel">
        <div id="search-feedback" style="margin-bottom:20px;color:var(--c-accent);font-family:var(--f-mono);"></div>
        <div class="product-grid" id="product-container"><div style="padding:20px;">CONNECTING...</div></div>
        <div class="pagination" style="display:flex;justify-content:center;gap:20px;margin-top:40px;font-family:var(--f-mono);">
            <button onclick="changePage(-1)" id="prev-btn" style="background:none;border:none;">PREV</button>
            <span id="page-info">1</span>
            <button onclick="changePage(1)" id="next-btn" style="background:none;border:none;">NEXT</button>
        </div>
    </main>
</div>
<script>
const isDeployed = window.location.hostname.includes('onrender.com');
const API_BASE = isDeployed ? 'https://jiyi-zhumeng.onrender.com' : 'http://localhost:3000';
let allProducts = [], currentPage = 1, pageSize = 6, currentCategory = 'all', isSearchMode = false, filteredSearchResults = [];

window.onload = function() {
    loadProducts(); checkLoginStatus(); initFloatingCart(); initCursor(); initHeroParallax();
    window.addEventListener('scroll', () => {
        const h = document.documentElement;
        document.getElementById('progressIndicator').style.width = (h.scrollTop / (h.scrollHeight - h.clientHeight)) * 100 + '%';
    });
};

function initCursor() {
    const dot = document.getElementById('cursor-ink-dot'), wash = document.getElementById('cursor-ink-wash');
    window.addEventListener('mousemove', e => {
        dot.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
        wash.animate({ transform: `translate(${e.clientX - wash.offsetWidth/2}px, ${e.clientY - wash.offsetHeight/2}px)` }, { duration: 600, fill: "forwards" });
    });
    document.body.addEventListener('mouseover', e => {
        if (e.target.closest('a, button, .product-card, .dynasty-mark')) wash.classList.add('ink-stain-active');
    });
    document.body.addEventListener('mouseout', e => {
        if (e.target.closest('a, button, .product-card, .dynasty-mark')) wash.classList.remove('ink-stain-active');
    });
}

function initHeroParallax() {
    const region = document.getElementById('heroRegion'), typo = document.getElementById('heroTypo');
    region.addEventListener('mousemove', e => {
        const x = (e.clientX - window.innerWidth/2) / 30, y = (e.clientY - window.innerHeight/2) / 12;
        typo.style.transform = `translate(${x}px, ${y}px)`;
    });
}

function bindTilt(card) {
    card.addEventListener('mousemove', e => {
        const r = card.getBoundingClientRect(), x = e.clientX - r.left, y = e.clientY - r.top;
        const rx = (r.height / 2 - y) / 12, ry = (x - r.width / 2) / 12;
        card.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) scale3d(1.05, 1.05, 1.05)`;
    });
    card.addEventListener('mouseleave', () => card.style.transform = `rotateX(0) rotateY(0) scale3d(1, 1, 1)`);
}

async function loadProducts() {
    try {
        const res = await fetch(`${API_BASE}/api/products?page=1`);
        const data = await res.json(); allProducts = data.items;
        if(data.totalPages > 1) {
            for(let i=2; i<=data.totalPages; i++) {
                const r = await fetch(`${API_BASE}/api/products?page=${i}`);
                const d = await r.json(); allProducts = allProducts.concat(d.items);
            }
        }
        loadProductsByPage(1);
    } catch (e) {
        allProducts = [{id:1, name:"微缩避暑山庄", price:399, category:"工艺品"}, {id:2, name:"蔚县剪纸", price:168, category:"剪纸"}];
        loadProductsByPage(1);
    }
}

function loadProductsByPage(page) {
    currentPage = page;
    let list = isSearchMode ? [...filteredSearchResults] : [...allProducts];
    if(currentCategory !== 'all') list = list.filter(p => p.category === currentCategory);
    const total = Math.ceil(list.length / pageSize) || 1;
    renderProducts(list.slice((page-1)*pageSize, page*pageSize));
    document.getElementById('page-info').textContent = page;
    document.getElementById('prev-btn').disabled = page <= 1;
    document.getElementById('next-btn').disabled = page >= total;
}

function renderProducts(products) {
    const container = document.getElementById('product-container');
    container.innerHTML = products.length ? '' : '<div class="error-msg">暂无匹配藏品</div>';
    products.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'product-card';
        let img = item.img || `https://placehold.co/400x400/E0DED9/2F4842?text=${encodeURIComponent(item.name)}`;
        if (img && !img.startsWith('http')) img = `${API_BASE}/images/${img.split('/').pop()}`;
        card.innerHTML = `<div class="p-image-wrap"><img src="${img}" class="p-img" id="pimg-${item.id}"><div class="p-tag">NO.${item.id.toString().padStart(3,'0')}</div>${item.category==='工艺品'?'<div class="p-blindbox-tag">限量系列</div>':''}<div class="quick-view-overlay"><button class="quick-view-btn" onclick="openQuickView(${item.id})">快速预览</button></div></div><div class="p-info"><div><h3 style="font-size:18px;">${item.name}</h3><div style="font-size:12px;color:#999;">${item.category}</div></div><div class="p-price">¥${item.price}</div></div><button class="btn-add-cart" onclick="addToCart(${item.id})">加入购物车</button>`;
        container.appendChild(card); bindTilt(card);
        setTimeout(() => { const i = document.getElementById(`pimg-${item.id}`); if(i) i.classList.add('fade-in'); }, index * 200);
    });
}

function filterProducts(cat) {
    currentCategory = cat; isSearchMode = false;
    document.querySelectorAll('#category-filters button').forEach(b => {
        b.classList.remove('active');
        if(b.getAttribute('onclick').includes(`'${cat}'`)) b.classList.add('active');
    });
    loadProductsByPage(1);
}

function performSearch() {
    const q = document.getElementById('search-input').value.trim().toLowerCase();
    if(!q) { isSearchMode = false; loadProductsByPage(1); return; }
    filteredSearchResults = allProducts.filter(p => p.name.toLowerCase().includes(q));
    isSearchMode = true; currentCategory = 'all'; loadProductsByPage(1);
}

function changePage(d) { loadProductsByPage(currentPage + d); }
function checkLoginStatus() {
    const u = localStorage.getItem('currentUser');
    document.getElementById('auth-section').innerHTML = u ? `<a>${u}</a><a href="javascript:logout()">退出</a>` : `<a href="login.html">登录</a><a href="register.html">注册</a>`;
}
function logout() { localStorage.removeItem('currentUser'); location.reload(); }
async function initFloatingCart() {
    const u = localStorage.getItem('currentUser');
    if(u) {
        const res = await fetch(`${API_BASE}/api/cart?username=${u}`);
        const data = await res.json(); document.getElementById('floatingCartCount').textContent = data.length;
    }
}
function addToCart(id) {
    const u = localStorage.getItem('currentUser'); if(!u) { alert('请先登录'); return; }
    const p = allProducts.find(x => x.id === id);
    fetch(`${API_BASE}/api/cart/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, product: p}) }).then(() => { initFloatingCart(); alert('已加入购物车'); });
}
function openQuickView(id) {
    const p = allProducts.find(x => x.id === id);
    const modal = document.createElement('div');
    modal.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:9999;";
    modal.innerHTML = `<div style="background:#fff;padding:40px;max-width:800px;width:90%;position:relative;"><span onclick="this.parentElement.parentElement.remove()" style="position:absolute;top:10px;right:20px;font-size:30px;cursor:pointer;">&times;</span><h2>${p.name}</h2><p>¥${p.price}</p><p>${p.category}</p></div>`;
    document.body.appendChild(modal);
}
</script>
</body>
</html>
