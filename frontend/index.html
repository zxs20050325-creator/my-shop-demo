<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冀遗筑梦 | 数字化分析平台</title>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* ========================================
           0. 设计系统 (核心变量)
           ======================================== */
        :root {
            --c-primary: #2F4842;    /* 青黛 */
            --c-accent: #C1A268;     /* 鎏金 */
            --c-bg: #F2F0EB;         /* 宣纸灰 */
            --c-grid: #E0DED9;       /* 网格线 */
            --f-serif: 'Noto Serif SC', 'Songti SC', serif;
            --f-mono: 'Courier New', monospace;
            --sidebar-width: 90px;
        }

        /* ========================================
           [效果组合]：墨金简约光标
           ======================================== */
        body { cursor: none !important; }
        a, button, .dynasty-mark, .product-card { cursor: none !important; }

        #cursor-ink {
            width: 8px; height: 8px; background: var(--c-primary);
            position: fixed; pointer-events: none; border-radius: 50%; z-index: 10001;
        }
        #cursor-wash {
            width: 28px; height: 28px; 
            background: radial-gradient(circle, rgba(47,72,66,0.1) 0%, transparent 80%);
            border: 1px solid rgba(47, 72, 66, 0.15);
            position: fixed; pointer-events: none; border-radius: 50%; z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1), height 0.4s, background 0.4s, filter 0.4s;
        }
        /* 交互反馈：金粉洇墨感 */
        .ink-active {
            width: 50px !important; height: 50px !important;
            background: radial-gradient(circle, rgba(193, 162, 104, 0.2) 0%, transparent 70%) !important;
            border-color: var(--c-accent) !important;
            filter: blur(2px);
        }

        /* ========================================
           基础布局
           ======================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: var(--c-bg); color: var(--c-primary);
            font-family: var(--f-serif); overflow-x: hidden;
            background-image: linear-gradient(var(--c-grid) 1px, transparent 1px), linear-gradient(90deg, var(--c-grid) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* [效果 4]：品牌名印章化侧边栏 */
        .sidebar {
            position: fixed; left: 0; top: 0; bottom: 0; width: var(--sidebar-width);
            background: #fff; border-right: 1px solid var(--c-primary);
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 40px 0; z-index: 1000;
        }
        .brand-box { position: relative; padding: 30px 10px; border: 1.5px solid var(--c-primary); background: #fff; }
        .brand-vertical { writing-mode: vertical-rl; font-size: 24px; font-weight: 900; letter-spacing: 8px; }
        .brand-stamp {
            position: absolute; bottom: -10px; left: 50%; width: 12px; height: 12px;
            background: #B22222; transform: translateX(-50%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .brand-box:hover .brand-stamp { transform: translateX(-50%) scale(1.3) translateY(5px); }

        .time-ruler { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 40px; position: relative; }
        .dynasty-mark { font-family: var(--f-mono); font-size: 12px; background: #fff; padding: 4px; z-index: 2; transition: 0.3s; color: var(--c-text-light); }
        .dynasty-mark.active { color: var(--c-primary); font-weight: bold; transform: scale(1.2); }

        .main-wrapper {
            margin-left: var(--sidebar-width); min-height: 100vh;
            display: grid; grid-template-columns: 240px 1fr;
            grid-template-areas: "top-bar top-bar" "hero hero" "filter content";
        }

        /* ========================================
           [排版优化]：首屏华塔巨幕 (Hero Section)
           ======================================== */
        .top-bar { grid-area: top-bar; padding: 30px 60px; display: flex; justify-content: flex-end; align-items: center; gap: 40px; }
        .hero-section {
            grid-area: hero; padding: 0 60px 80px; position: relative;
            height: 700px; /* 高度增加 */
            display: flex; align-items: center; overflow: hidden;
        }
        
        /* [视差大字]：多层位移效果 */
        .parallax-text {
            position: absolute; font-size: 26vw; font-weight: 900; line-height: 1; pointer-events: none;
            mix-blend-mode: multiply; /* 宣纸透印效果 */
        }
        #word-zhu { color: rgba(47, 72, 66, 0.04); top: 0px; left: 0; }
        #word-meng { color: rgba(193, 162, 104, 0.06); bottom: 50px; right: 50px; }

        .hero-card { display: flex; align-items: center; gap: 80px; z-index: 10; width: 100%; }
        .hero-image-box { 
            position: relative; width: 550px; height: 600px; /* 华塔照片变大 */
            transition: transform 0.5s ease;
        }
        .hero-image-box::before {
            content: ''; position: absolute; top: -20px; left: -20px; width: 100%; height: 100%;
            border: 1px solid var(--c-accent); z-index: -1;
        }
        .hero-img { width: 100%; height: 100%; object-fit: cover; box-shadow: 20px 20px 60px rgba(0,0,0,0.1); }
        .hero-text h1 { font-size: 52px; margin-bottom: 20px; letter-spacing: 2px; }
        .hero-text p { font-size: 18px; line-height: 1.8; color: #555; max-width: 450px; margin-bottom: 40px; text-align: justify;}

        /* ========================================
           [排版优化]：商品展示 (图片变小)
           ======================================== */
        .filter-panel { grid-area: filter; padding: 40px; border-right: 1px dashed var(--c-grid); position: sticky; top: 0; height: 100vh; }
        .content-panel { grid-area: content; padding: 40px 60px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 50px; perspective: 1200px; }
        
        /* [3D倾斜与掠金] */
        .product-card {
            background: transparent; position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .p-image-wrap {
            height: 240px; /* 商品图片变小 */
            background: #fff; position: relative; overflow: hidden;
            border: 1px solid transparent; transform: translateZ(20px);
            transition: border 0.4s, box-shadow 0.4s;
        }
        /* 掠金扫影效果 */
        .product-card::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(193, 162, 104, 0.2), transparent);
            transform: skewX(-25deg); transition: 0s; pointer-events: none;
        }
        .product-card:hover::after { left: 150%; transition: 0.8s ease-in-out; }
        
        .product-card:hover .p-image-wrap { border-color: var(--c-accent); box-shadow: 15px 15px 0 rgba(44, 74, 71, 0.05); }
        .p-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transform: translateY(20px); transition: 1.5s ease-out; }
        .p-img.fade-in { opacity: 1; transform: translateY(0); }

        .p-info { margin-top: 15px; display: flex; justify-content: space-between; align-items: flex-end; transform: translateZ(35px); }
        .p-price { color: var(--c-accent); font-weight: bold; font-family: var(--f-mono); }
        .btn-add-cart { 
            margin-top: 15px; width: 100%; padding: 10px; background: #fff; 
            border: 1px solid var(--c-primary); font-size: 12px; opacity: 0; transition: 0.3s; 
        }
        .product-card:hover .btn-add-cart { opacity: 1; }

        .pagination { margin-top: 80px; display: flex; justify-content: center; gap: 20px; font-family: var(--f-mono); }
        .progress-indicator { position: fixed; top: 0; left: 0; width: 0%; height: 3px; background: var(--c-accent); z-index: 1001; }

        @media (max-width: 1024px) {
            .hero-card { flex-direction: column; }
            .hero-image-box { width: 100%; height: 400px; }
            .main-wrapper { grid-template-columns: 1fr; grid-template-areas: "top-bar" "hero" "filter" "content"; }
        }
    </style>
</head>
<body>
    <!-- [效果 2]：光标元素 -->
    <div id="cursor-ink"></div>
    <div id="cursor-wash"></div>

    <div class="progress-indicator" id="progressIndicator"></div>

    <aside class="sidebar">
        <!-- [效果 4]：品牌反馈 -->
        <div class="brand-box">
            <div class="brand-vertical">冀遗筑梦</div>
            <div class="brand-stamp"></div>
        </div>
        <div class="time-ruler">
            <div class="dynasty-mark">SUI</div>
            <div class="dynasty-mark active">TANG</div>
            <div class="dynasty-mark">SONG</div>
            <div class="dynasty-mark">MING</div>
            <div class="dynasty-mark">QING</div>
        </div>
        <div class="social-links"><i class="fa fa-weixin"></i><i class="fa fa-weibo"></i></div>
    </aside>

    <div class="main-wrapper">
        <header class="top-bar">
            <div style="display:flex; align-items:center; border-bottom:1px solid var(--c-primary);">
                <input type="text" id="search-input" placeholder="SEARCH..." style="background:none; border:none; outline:none; padding:5px; text-align:right;">
                <button onclick="performSearch()" style="background:none; border:none; padding:5px;"><i class="fa fa-search"></i></button>
            </div>
            <div id="auth-section" style="font-family:var(--f-mono); font-size:12px; margin-left:30px;"></div>
        </header>

        <!-- [排版优化]：巨幕展示广惠寺华塔 -->
        <section class="hero-section" id="heroRegion">
            <!-- [效果 3]：多层视差大字 -->
            <div class="parallax-text" id="word-zhu">筑</div>
            <div class="parallax-text" id="word-meng">梦</div>
            
            <div class="hero-card">
                <div class="hero-image-box">
                    <!-- 此处建议替换为您服务器上真实的华塔高清大图 -->
                    <img src="https://picsum.photos/id/1043/1000/1200" alt="正定广惠寺华塔" class="hero-img">
                </div>
                <div class="hero-text">
                    <div style="color:var(--c-accent); font-family:var(--f-mono); letter-spacing:3px; margin-bottom:10px;">ZHENGDING ANCIENT CITY</div>
                    <h1>广惠寺 · 华塔</h1>
                    <p>
                        " 举世无双之孤例 "。<br>
                        作为正定古城最精美的古建之一，其塔身密布狮、象、佛像浮雕，数字化扫描还原每一寸砖石的呼吸，重现千年前的繁复美学。
                    </p>
                    <button style="padding:15px 40px; background:var(--c-primary); color:#fff; border:none; font-family:var(--f-serif); letter-spacing:2px;">探索数字化档案</button>
                </div>
            </div>
        </section>

        <aside class="filter-panel">
            <div style="font-size:12px; color:var(--c-text-light); margin-bottom:20px;">CATEGORY 分类</div>
            <div id="category-filters" style="display:flex; flex-direction:column; gap:15px;">
                <button class="active" onclick="filterProducts('all')" style="background:none; border:none; text-align:left; font-size:16px;">全部 / ALL</button>
                <button onclick="filterProducts('工艺品')" style="background:none; border:none; text-align:left; font-size:16px;">工艺 / CRAFT</button>
                <button onclick="filterProducts('剪纸')" style="background:none; border:none; text-align:left; font-size:16px;">剪纸 / PAPER</button>
                <button onclick="filterProducts('雕刻')" style="background:none; border:none; text-align:left; font-size:16px;">雕刻 / CARVING</button>
            </div>
        </aside>

        <main class="content-panel">
            <div id="search-feedback" style="margin-bottom:20px; color:var(--c-accent);"></div>
            <div class="product-grid" id="product-container">
                <!-- 商品加载占位 -->
            </div>
            <div class="pagination">
                <button id="prev-btn" onclick="changePage(-1)" style="background:none; border:none;">PREV</button>
                <span id="page-info">1</span>
                <button id="next-btn" onclick="changePage(1)" style="background:none; border:none;">NEXT</button>
            </div>
        </main>
    </div>

    <script>
        const isDeployed = window.location.hostname.includes('onrender.com');
        const API_BASE = isDeployed ? 'https://jiyi-zhumeng.onrender.com' : 'http://localhost:3000';
        
        let allProducts = [], currentPage = 1, pageSize = 8; // 下方商品较小，每页显示8个
        let currentCategory = 'all', isSearchMode = false, filteredSearchResults = [];

        window.onload = function() {
            loadProducts();
            checkLoginStatus();
            initCursor();
            initHeroParallax();
            window.addEventListener('scroll', handleScroll);
        };

        // [效果 2]：墨金光标逻辑
        function initCursor() {
            const ink = document.getElementById('cursor-ink');
            const wash = document.getElementById('cursor-wash');
            window.addEventListener('mousemove', (e) => {
                ink.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
                wash.animate({
                    transform: `translate(${e.clientX - wash.offsetWidth/2}px, ${e.clientY - wash.offsetHeight/2}px)`
                }, { duration: 500, fill: "forwards" });
            });
            document.body.addEventListener('mouseover', (e) => {
                if (e.target.closest('a, button, .product-card, .dynasty-mark')) wash.classList.add('ink-active');
            });
            document.body.addEventListener('mouseout', (e) => {
                if (e.target.closest('a, button, .product-card, .dynasty-mark')) wash.classList.remove('ink-active');
            });
        }

        // [效果 3]：分层视差大字
        function initHeroParallax() {
            const region = document.getElementById('heroRegion');
            const zhu = document.getElementById('word-zhu');
            const meng = document.getElementById('word-meng');
            region.addEventListener('mousemove', (e) => {
                const moveX = (e.clientX - window.innerWidth/2);
                const moveY = (e.clientY - window.innerHeight/2);
                zhu.style.transform = `translate(${moveX/25}px, ${moveY/15}px)`;
                meng.style.transform = `translate(${moveX/40}px, ${moveY/25}px)`;
            });
        }

        // [效果 1]：物理阻尼 3D 倾斜
        function bindTilt(card) {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width - 0.5;
                const y = (e.clientY - rect.top) / rect.height - 0.5;
                card.style.transform = `perspective(1000px) rotateY(${x * 15}deg) rotateX(${-y * 15}deg) scale3d(1.02, 1.02, 1.02)`;
            });
            card.addEventListener('mouseleave', () => {
                // 物理回弹效果：通过 CSS transition 实现，无需额外 JS
                card.style.transform = `perspective(1000px) rotateY(0deg) rotateX(0deg) scale3d(1, 1, 1)`;
            });
        }

        // 数据加载与渲染
        async function loadProducts() {
            try {
                const res = await fetch(`${API_BASE}/api/products?page=1`);
                const data = await res.json();
                allProducts = data.items;
                // 尝试获取全量数据以支持本地过滤
                if(data.totalPages > 1) {
                    for(let i=2; i<=data.totalPages; i++){
                        const r = await fetch(`${API_BASE}/api/products?page=${i}`);
                        const d = await r.json();
                        allProducts = allProducts.concat(d.items);
                    }
                }
                loadProductsByPage(1);
            } catch (e) {
                console.error("Using backup data...");
                allProducts = [
                    {id:1, name:"华塔微缩模型", price:599, category:"工艺品"},
                    {id:2, name:"正定古城剪纸", price:128, category:"剪纸"},
                    {id:3, name:"石狮雕刻摆件", price:268, category:"雕刻"}
                ];
                loadProductsByPage(1);
            }
        }

        function loadProductsByPage(page) {
            currentPage = page;
            let list = isSearchMode ? [...filteredSearchResults] : [...allProducts];
            if(currentCategory !== 'all') list = list.filter(p => p.category === currentCategory);
            
            const totalPages = Math.ceil(list.length / pageSize) || 1;
            const start = (page - 1) * pageSize;
            const pageData = list.slice(start, start + pageSize);
            
            const container = document.getElementById('product-container');
            container.innerHTML = '';
            
            // [效果 C]：阶梯式延迟滑入
            pageData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                let imgSrc = item.img || `https://placehold.co/400x300/E0DED9/2F4842?text=${encodeURIComponent(item.name)}`;
                if(imgSrc && !imgSrc.startsWith('http')) imgSrc = `${API_BASE}/images/${imgSrc.split('/').pop()}`;

                card.innerHTML = `
                    <div class="p-image-wrap">
                        <img src="${imgSrc}" class="p-img" id="pimg-${item.id}">
                        <div style="position:absolute; top:10px; left:10px; background:var(--c-primary); color:#fff; font-size:10px; padding:3px 8px;">NO.${item.id}</div>
                    </div>
                    <div class="p-info">
                        <div><h3 style="font-size:16px;">${item.name}</h3><div style="font-size:12px; color:#999;">${item.category}</div></div>
                        <div class="p-price">¥${item.price}</div>
                    </div>
                    <button class="btn-add-cart">ADD TO CART</button>
                `;
                container.appendChild(card);
                bindTilt(card);
                
                setTimeout(() => {
                    const img = document.getElementById(`pimg-${item.id}`);
                    if(img) img.classList.add('fade-in');
                }, index * 80); // 80ms 阶梯延迟
            });

            document.getElementById('page-info').textContent = page;
            document.getElementById('prev-btn').disabled = page <= 1;
            document.getElementById('next-btn').disabled = page >= totalPages;
        }

        function handleScroll() {
            const h = document.documentElement;
            const scrolled = (h.scrollTop / (h.scrollHeight - h.clientHeight)) * 100;
            document.getElementById('progressIndicator').style.width = scrolled + '%';
        }

        function filterProducts(cat) {
            currentCategory = cat; isSearchMode = false;
            document.querySelectorAll('#category-filters button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadProductsByPage(1);
        }

        function performSearch() {
            const q = document.getElementById('search-input').value.trim().toLowerCase();
            filteredSearchResults = allProducts.filter(p => p.name.toLowerCase().includes(q));
            isSearchMode = true; currentCategory = 'all';
            loadProductsByPage(1);
        }

        function changePage(d) { loadProductsByPage(currentPage + d); }

        function checkLoginStatus() {
            const u = localStorage.getItem('currentUser');
            document.getElementById('auth-section').innerHTML = u ? `<a>${u}</a> <a href="#" onclick="localStorage.clear();location.reload()">退出</a>` : `<a href="login.html">登录</a>`;
        }
    </script>
</body>
</html>
