<!DOCTYPE html>
<html lang="zh-CN">
<!--
    =============================================================================
    项目名称：冀遗筑梦 - 旗舰级数字化非遗盲盒平台 (ULTIMATE EDITION V7.0)
    
    【V7.0 更新日志 - 体验重构】
    1. [BlindBox Core] 新增“封印/解封”双态逻辑。默认展示3D锦盒，交互后播放粒子特效揭晓文物。
    2. [Rarity System] 稀有度视觉分级：SSR(流光金)/SR(皓月银)/R(原木韵)。
    3. [Layout] Hero区重构为“竖排书法+透视层叠”布局；商品区采用错位流式网格。
    4. [UX Motion] 新增抛物线加入购物车动画、页面转场水墨洇开效果。
    5. [Legacy] 完整保留API通讯、登录鉴权、物理光标等原有核心代码。
    =============================================================================
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>冀遗筑梦 | 全球首个非遗盲盒数字化平台</title>
    
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700;900&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">

    <style>
        :root {
            /* [色彩系统] - 保持原有青绿调性，增加稀有度色 */
            --c-primary: #2F4842;    /* 青黛 */
            --c-dark: #1a2b27;       /* 深墨 */
            --c-accent: #C1A268;     /* 鎏金 */
            --c-bg: #F5F3EF;         /* 宣纸白 */
            --c-grid: #E6E2DC;       /* 网格线 */
            --c-ssr: #FFD700;        /* SSR 金光 */
            --c-sr: #C0C0C0;         /* SR 银光 */
            --c-r: #8B5A2B;          /* R 木色 */
            --c-danger: #B22222;     /* 朱砂红 */
            
            /* [字体系统] */
            --f-serif: 'Noto Serif SC', serif;
            --f-art: 'Ma Shan Zheng', serif; /* 书法体 */
            --f-mono: 'Courier New', monospace;
            
            --sidebar-width: 90px;
            --trans-spring: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* [1. 全局与水墨光标] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--c-bg); color: var(--c-primary); 
            font-family: var(--f-serif); overflow-x: hidden; 
            cursor: none; /* 隐藏默认光标 */
        }
        
        /* 网格背景 - 增加噪点质感 */
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-image: 
                linear-gradient(var(--c-grid) 1px, transparent 1px), 
                linear-gradient(90deg, var(--c-grid) 1px, transparent 1px); 
            background-size: 60px 60px; z-index: -2; opacity: 0.6; pointer-events: none; 
        }

        /* 移动端恢复默认光标 */
        @media (hover: none) { body { cursor: auto; } #cursor-dot, #cursor-wash { display: none; } }

        /* 光标样式 */
        #cursor-dot { width: 8px; height: 8px; background: var(--c-primary); position: fixed; pointer-events: none; border-radius: 50%; z-index: 10001; transform: translate(-50%, -50%); transition: transform 0.1s; }
        #cursor-wash { width: 40px; height: 40px; border: 1px solid rgba(47, 72, 66, 0.4); position: fixed; pointer-events: none; border-radius: 50%; z-index: 10000; transform: translate(-50%, -50%); transition: width 0.3s, height 0.3s, background 0.3s; mix-blend-mode: multiply; }
        .hover-active #cursor-wash { width: 70px; height: 70px; background: rgba(193, 162, 104, 0.15); border-color: var(--c-accent); backdrop-filter: blur(2px); }

        /* [2. 侧边栏 - 保持不变] */
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: #fff; border-right: 1px solid var(--c-primary); display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 40px 0; z-index: 4500; transition: width 0.3s; }
        .sidebar:hover { width: 160px; } /* 悬停展开 */
        .brand-plaque { background: var(--c-primary); color: #fff; padding: 25px 12px; border-radius: 2px; box-shadow: 4px 4px 0 var(--c-accent); transition: var(--trans-spring); white-space: nowrap; overflow: hidden; }
        .brand-vertical { writing-mode: vertical-rl; font-size: 20px; font-weight: 900; letter-spacing: 5px; }
        .series-axis { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 30px; width: 100%; }
        .series-mark { display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; opacity: 0.5; transition: 0.3s; padding: 10px; }
        .series-mark.active, .series-mark:hover { opacity: 1; transform: scale(1.1); color: var(--c-accent); }
        .series-num { font-family: var(--f-mono); font-weight: bold; }
        .series-name { font-size: 12px; display: none; white-space: nowrap; }
        .sidebar:hover .series-name { display: block; animation: fadeIn 0.3s; }

        /* [3. 顶部导航] */
        .main-content { margin-left: var(--sidebar-width); position: relative; z-index: 100; transition: margin 0.3s; }
        .top-bar { position: sticky; top: 0; height: 80px; padding: 0 5%; display: flex; justify-content: space-between; align-items: center; z-index: 4000; background: rgba(245, 243, 239, 0.85); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(47,72,66,0.05); }
        
        /* 顶部筛选条 (新设计) */
        .filter-dock { display: flex; gap: 30px; }
        .filter-btn { background: none; border: none; font-size: 14px; color: #888; cursor: pointer; position: relative; padding: 5px 0; font-family: var(--f-serif); }
        .filter-btn.active { color: var(--c-primary); font-weight: bold; }
        .filter-btn.active::after { content: '·'; color: var(--c-accent); font-size: 30px; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); }

        .user-dock { display: flex; gap: 20px; align-items: center; }
        .icon-btn { position: relative; font-size: 18px; cursor: pointer; transition: 0.3s; }
        .icon-btn:hover { color: var(--c-accent); transform: translateY(-2px); }
        #cartBadge { position: absolute; top: -5px; right: -8px; background: var(--c-danger); color: #fff; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--f-mono); }

        /* [4. Hero 区域重构 - 高定杂志风] */
        .hero-section { 
            height: 90vh; 
            position: relative; 
            display: grid; 
            grid-template-columns: 1fr 1.2fr; /* 左文右图 */
            align-items: center; 
            overflow: hidden;
            padding: 0 5%;
        }
        
        /* 背景水印 */
        .watermark-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.05; font-family: var(--f-art); overflow: hidden; }
        .watermark-word { position: absolute; font-size: 30vw; line-height: 1; color: var(--c-primary); }
        #wm-zhu { top: -10%; left: -5%; }
        #wm-meng { bottom: -10%; right: -5%; color: var(--c-accent); }

        /* 左侧文字区 (压在图片上层) */
        .hero-text-layer { 
            position: relative; 
            z-index: 10; 
            padding: 60px; 
            background: rgba(255,255,255,0.7); 
            backdrop-filter: blur(5px);
            border: 1px solid rgba(47,72,66,0.1);
            box-shadow: 20px 20px 60px rgba(0,0,0,0.05);
            margin-right: -100px; /* 负边距重叠 */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .hero-title-group { display: flex; gap: 20px; align-items: flex-start; margin-bottom: 30px; }
        .hero-title-main { 
            font-size: 64px; font-weight: 900; line-height: 1.1; 
            writing-mode: vertical-rl; /* 竖排文字 */
            letter-spacing: 5px; color: var(--c-primary);
        }
        .hero-title-sub {
            writing-mode: vertical-rl; font-family: var(--f-mono); 
            color: var(--c-accent); letter-spacing: 2px; font-size: 14px; margin-top: 10px;
        }
        .hero-desc { max-width: 400px; line-height: 1.8; color: #555; font-size: 15px; margin-bottom: 40px; text-align: justify; }

        .btn-cta { 
            padding: 15px 40px; background: var(--c-primary); color: #fff; border: none; 
            font-family: var(--f-mono); letter-spacing: 2px; cursor: pointer; transition: 0.3s; 
            position: relative; overflow: hidden;
        }
        .btn-cta::before { content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: 0.5s; }
        .btn-cta:hover::before { left: 100%; }
        .btn-cta:hover { background: var(--c-accent); box-shadow: 0 10px 20px rgba(193, 162, 104, 0.3); }

        /* 右侧图片区 */
        .hero-img-layer { 
            position: relative; 
            width: 100%; height: 85%; 
            z-index: 1;
        }
        .hero-img { 
            width: 100%; height: 100%; object-fit: cover; 
            filter: sepia(0.1) contrast(1.1); 
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%); /* 切角造型 */
            transition: 1s;
        }
        .hero-img:hover { transform: scale(1.02); filter: none; }

        /* [5. 商品网格 - 错位流式布局] */
        .shop-section { padding: 80px 5%; position: relative; }
        .section-header { margin-bottom: 60px; display: flex; align-items: flex-end; justify-content: space-between; border-bottom: 1px solid var(--c-grid); padding-bottom: 20px; }
        .section-title { font-size: 32px; font-weight: bold; }
        .section-subtitle { font-family: var(--f-mono); color: #888; font-size: 12px; }

        .masonry-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 50px; 
            perspective: 1000px;
        }

        /* [6. 盲盒卡片 - 核心双态逻辑] */
        .blind-card { 
            position: relative; background: transparent; min-height: 420px; cursor: pointer; 
            transition: transform 0.4s var(--trans-spring);
        }
        .blind-card:hover { transform: translateY(-10px); }
        /* 偶数卡片下沉，制造错位感 */
        .blind-card:nth-child(even) { transform: translateY(40px); }
        .blind-card:nth-child(even):hover { transform: translateY(30px); }

        /* 状态A: 封印状态 (盒子) */
        .card-sealed { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; padding: 20px; border: 1px solid #eee;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s, transform 0.5s;
            backface-visibility: hidden; z-index: 2;
        }
        .box-3d-model { 
            width: 200px; height: 200px; object-fit: contain; margin-bottom: 20px; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1));
            animation: floatBox 3s ease-in-out infinite;
        }
        @keyframes floatBox { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        
        .seal-tag { 
            font-family: var(--f-art); font-size: 24px; color: var(--c-primary); 
            border: 2px solid var(--c-primary); padding: 5px 15px; border-radius: 4px;
        }

        /* 状态B: 解封状态 (文物) */
        .card-revealed { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; padding: 0; overflow: hidden;
            display: flex; flex-direction: column;
            opacity: 0; transform: rotateY(180deg);
            transition: opacity 0.5s, transform 0.5s;
            backface-visibility: hidden; z-index: 1;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        /* 稀有度边框光效 */
        .card-revealed.rarity-SSR { border: 2px solid var(--c-ssr); box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        .card-revealed.rarity-SR { border: 2px solid var(--c-sr); }
        .card-revealed.rarity-R { border: 1px solid var(--c-r); }

        .artifact-img { width: 100%; height: 70%; object-fit: cover; background: #f9f9f9; }
        .artifact-info { padding: 20px; text-align: left; }
        .artifact-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #333; }
        .artifact-meta { display: flex; justify-content: space-between; align-items: center; }
        .artifact-price { font-family: var(--f-mono); color: var(--c-danger); font-size: 18px; font-weight: bold; }
        .btn-add-mini { background: var(--c-primary); color: #fff; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: 0.3s; }
        .btn-add-mini:hover { background: var(--c-accent); transform: scale(1.1); }

        /* 拆盒动画类 */
        .blind-card.is-open .card-sealed { opacity: 0; transform: rotateY(180deg); }
        .blind-card.is-open .card-revealed { opacity: 1; transform: rotateY(360deg); z-index: 3; }
        
        /* 拆盒时的特效粒子 (CSS模拟) */
        .burst-effect {
            position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            border-radius: 50%; background: radial-gradient(circle, var(--c-ssr) 0%, transparent 70%);
            z-index: 5; pointer-events: none; opacity: 0;
        }
        @keyframes burstAnim {
            0% { width: 0; height: 0; opacity: 1; }
            100% { width: 500px; height: 500px; opacity: 0; }
        }

        /* [7. 购物车抛物线球] */
        .fly-ball {
            position: fixed; width: 20px; height: 20px; background: var(--c-danger);
            border-radius: 50%; z-index: 9999; pointer-events: none;
            box-shadow: 0 0 10px rgba(178, 34, 34, 0.5);
            transition: top 0.8s cubic-bezier(0.19, 1, 0.22, 1), left 0.8s linear;
        }

        /* [8. 弹窗与抽屉] */
        .drawer-overlay { position: fixed; top: 0; right: -400px; width: 380px; height: 100%; background: #fff; z-index: 5000; box-shadow: -10px 0 30px rgba(0,0,0,0.1); transition: 0.4s var(--trans-spring); padding: 30px; }
        .drawer-overlay.open { right: 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 6000; display: none; justify-content: center; align-items: center; }
        .login-box { background: #fff; padding: 40px; width: 400px; border-radius: 4px; position: relative; border-top: 4px solid var(--c-primary); }
        .ink-input { width: 100%; padding: 12px; border: 1px solid #ddd; margin-bottom: 20px; font-family: var(--f-serif); outline: none; transition: 0.3s; }
        .ink-input:focus { border-color: var(--c-primary); }

        /* 响应式适配 */
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .hero-section { grid-template-columns: 1fr; height: auto; padding: 100px 20px; }
            .hero-text-layer { margin-right: 0; margin-bottom: -50px; }
            .hero-title-main { writing-mode: horizontal-tb; font-size: 40px; }
            .hero-title-sub { writing-mode: horizontal-tb; }
            .product-grid { grid-template-columns: repeat(2, 1fr); }
            .blind-card:nth-child(even) { transform: none; }
            .blind-card:nth-child(even):hover { transform: translateY(-10px); }
        }
        @media (max-width: 768px) {
            .product-grid { grid-template-columns: 1fr; }
            .filter-dock { overflow-x: auto; padding-bottom: 10px; }
            .filter-btn { white-space: nowrap; }
        }
    </style>
</head>
<body>

    <!-- [交互层] -->
    <div id="cursor-dot"></div>
    <div id="cursor-wash"></div>
    <div class="watermark-layer">
        <div class="watermark-word" id="wm-zhu">筑</div>
        <div class="watermark-word" id="wm-meng">梦</div>
    </div>

    <!-- [侧边导航] -->
    <aside class="sidebar">
        <div class="brand-plaque">
            <div class="brand-vertical">冀遗筑梦</div>
        </div>
        <div class="series-axis">
            <div class="series-mark active"><span class="series-num">01</span><span class="series-name">正定古城</span></div>
            <div class="series-mark"><span class="series-num">02</span><span class="series-name">避暑山庄</span></div>
            <div class="series-mark"><span class="series-num">03</span><span class="series-name">赵州古桥</span></div>
        </div>
        <div style="font-size: 12px; font-family: var(--f-mono);">V7.0</div>
    </aside>

    <div class="main-content">
        <!-- [顶部导航] -->
        <header class="top-bar">
            <!-- 顶部筛选条 (替代原左侧筛选) -->
            <nav class="filter-dock">
                <button class="filter-btn active hover-target" onclick="app.filter('all', this)">全部藏品</button>
                <button class="filter-btn hover-target" onclick="app.filter('craft', this)">3D拼装</button>
                <button class="filter-btn hover-target" onclick="app.filter('blind', this)">限量盲盒</button>
                <button class="filter-btn hover-target" onclick="app.filter('art', this)">非遗文创</button>
            </nav>

            <div class="user-dock">
                <div class="search-wrap hover-target" style="border-bottom:1px solid #ccc; display:flex;">
                    <i class="fa fa-search" style="padding:5px;"></i>
                    <input type="text" placeholder="搜索遗珍..." id="searchInput" style="border:none; background:none; outline:none; font-family:var(--f-serif); width:120px;">
                </div>
                <div class="icon-btn hover-target" onclick="app.toggleCart()">
                    <i class="fa fa-shopping-bag"></i>
                    <div id="cartBadge">0</div>
                </div>
                <div class="icon-btn hover-target" onclick="app.toggleLogin()">
                    <i class="fa fa-user-o"></i>
                    <span id="userLabel" style="font-size:12px; margin-left:5px;">结缘</span>
                </div>
            </div>
        </header>

        <!-- [Hero 区域 - 高定版] -->
        <section class="hero-section">
            <div class="hero-text-layer">
                <div class="hero-title-group">
                    <div class="hero-title-main">广惠寺·华塔</div>
                    <div class="hero-title-sub">GUANGHUI TEMPLE<br>FLOWER PAGODA</div>
                </div>
                <p class="hero-desc">
                    “远视如花束，近观似浮图”。<br>
                    我们将正定“海内孤例”进行高精度3D数字重构。塔身第四层的力士、狮象浮雕，经由光固化3D打印技术，化作掌心可触摸的温度。
                </p>
                <button class="btn-cta hover-target" onclick="document.getElementById('shop').scrollIntoView({behavior:'smooth'})">开启寻宝之旅</button>
            </div>
            <div class="hero-img-layer">
                <!-- 华塔图片 (示例图) -->
                <img src="https://img.zcool.cn/community/016ca55d57b4c6a801214814d94b7e.jpg@1280w_1l_2o_100sh.jpg" class="hero-img" alt="华塔">
            </div>
        </section>

        <!-- [商品区 - 错位流式布局] -->
        <section class="shop-section" id="shop">
            <div class="section-header">
                <div>
                    <h2 class="section-title">遗珍阁</h2>
                    <span class="section-subtitle">ARCHIVE COLLECTION // SERIES 01</span>
                </div>
                <div style="font-family: var(--f-mono); font-size: 12px; color: #888;">
                    TOTAL: <span id="totalCount">0</span> ITEMS
                </div>
            </div>

            <div class="masonry-grid" id="productGrid">
                <!-- 商品卡片将由 JS 动态生成 -->
                <div style="grid-column: 1/-1; text-align: center; padding: 50px; font-family: var(--f-mono);">
                    LOADING DIGITAL ARCHIVES...
                </div>
            </div>
        </section>

        <footer style="text-align: center; padding: 50px; opacity: 0.4; font-size: 12px; font-family: var(--f-mono);">
            &copy; 2026 JIYI ZHUMENG. HEBEI HERITAGE DIGITALIZATION PROJECT.
        </footer>
    </div>

    <!-- [购物车侧滑抽屉] -->
    <div class="drawer-overlay" id="cartDrawer">
        <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
            <h3>惊喜袋</h3>
            <span style="cursor:pointer" onclick="app.toggleCart()">&times;</span>
        </div>
        <div id="cartItems" style="height: 80%; overflow-y: auto;">
            <p style="text-align:center; color:#999; margin-top:50px;">暂无遗珍</p>
        </div>
        <button class="btn-cta" style="width:100%; margin-top:20px;">前往结算</button>
    </div>

    <!-- [登录弹窗] -->
    <div class="modal-overlay" id="loginModal">
        <div class="login-box">
            <span style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:24px;" onclick="app.toggleLogin()">&times;</span>
            <h2 style="margin-bottom:30px; text-align:center;">文创结缘</h2>
            <input type="text" class="ink-input" id="username" placeholder="请输入名号...">
            <input type="password" class="ink-input" id="password" placeholder="密匙...">
            <button class="btn-cta" style="width:100%;" onclick="app.login()">认证身份</button>
        </div>
    </div>

    <script>
        /**
         * 冀遗筑梦 V7.0 核心引擎
         * 包含：双态盲盒逻辑、API数据加载、抛物线动画
         */
        class HeritageApp {
            constructor() {
                // 环境判断
                this.API_BASE = window.location.hostname.includes('onrender') 
                    ? 'https://jiyi-zhumeng.onrender.com' 
                    : 'http://localhost:3000';
                
                this.state = {
                    products: [], // 原始数据
                    cartCount: 0,
                    currentUser: null,
                    filter: 'all'
                };

                this.init();
            }

            init() {
                this.setupCursor();
                this.loadData();
                this.checkSession();
                this.setupSearch();
            }

            // [1. 数据加载]
            async loadData() {
                try {
                    // 尝试连接后端
                    const res = await fetch(`${this.API_BASE}/api/products?page=1`);
                    const data = await res.json();
                    
                    if (data.items && data.items.length > 0) {
                        // 数据预处理：增加 revealed 状态和 rarity 属性
                        this.state.products = data.items.map(item => ({
                            ...item,
                            revealed: false, // 默认未拆封
                            rarity: this.calculateRarity(item.price) // 根据价格计算稀有度
                        }));
                        
                        // 如果数据太少，复制几份以填充网格（仅供演示效果）
                        if(this.state.products.length < 6) {
                            this.state.products = [...this.state.products, ...this.state.products];
                        }
                    } else {
                        throw new Error("No data");
                    }
                } catch (e) {
                    console.warn("API load failed, using fallback data");
                    this.useFallbackData();
                }
                this.renderGrid();
            }

            // 备用数据生成
            useFallbackData() {
                const types = ['craft', 'blind', 'art'];
                const names = ['正定华塔', '隆兴寺·倒坐观音', '赵州桥·栏板', '避暑山庄·烟雨楼', '蔚县剪纸·戏曲', '曲阳石雕·雄狮'];
                this.state.products = Array.from({length: 8}, (_, i) => ({
                    id: i + 1,
                    name: names[i % names.length],
                    price: 59 + i * 20,
                    category: types[i % 3],
                    img: `https://placehold.co/400x500/2F4842/C1A268?text=ARTIFACT+${i+1}`,
                    revealed: false,
                    rarity: i === 0 ? 'SSR' : (i % 3 === 0 ? 'SR' : 'R')
                }));
            }

            calculateRarity(price) {
                if (price > 200) return 'SSR';
                if (price > 100) return 'SR';
                return 'R';
            }

            // [2. 渲染网格 - 核心逻辑]
            renderGrid() {
                const grid = document.getElementById('productGrid');
                grid.innerHTML = '';
                
                // 筛选
                const filtered = this.state.filter === 'all' 
                    ? this.state.products 
                    : this.state.products.filter(p => {
                        if (this.state.filter === 'blind') return p.category.includes('盲盒') || p.rarity === 'SSR';
                        if (this.state.filter === 'craft') return p.category === 'craft' || p.category.includes('工艺');
                        return p.category === this.state.filter;
                    });

                document.getElementById('totalCount').innerText = filtered.length;

                filtered.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = `blind-card ${item.revealed ? 'is-open' : ''}`;
                    // 延迟动画
                    card.style.transitionDelay = `${index * 0.1}s`;
                    
                    // 1. 未拆封层 (盒子)
                    // 使用占位图模拟锦盒，您可以替换为真实的锦盒图片
                    const boxImg = `https://placehold.co/300x300/C1A268/FFFFFF?text=SEALED+BOX`; 
                    
                    // 2. 已拆封层 (文物)
                    // 图片处理
                    let realImg = item.img;
                    if (!realImg.startsWith('http')) realImg = `${this.API_BASE}/images/${realImg}`;
                    
                    card.innerHTML = `
                        <!-- 封印面 -->
                        <div class="card-sealed">
                            <img src="${boxImg}" class="box-3d-model">
                            <div class="seal-tag">封印</div>
                            <p style="margin-top:10px; font-size:12px; color:#888;">点击解封遗珍</p>
                        </div>
                        
                        <!-- 揭晓面 -->
                        <div class="card-revealed rarity-${item.rarity}">
                            <img src="${realImg}" class="artifact-img" onerror="this.src='https://placehold.co/400x500?text=No+Image'">
                            <div class="artifact-info">
                                <div class="artifact-meta">
                                    <span style="font-size:10px; background:#f0f0f0; padding:2px 5px;">${item.rarity}</span>
                                    <span class="artifact-price">¥${item.price}</span>
                                </div>
                                <div class="artifact-name">${item.name}</div>
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                                    <span style="font-size:12px; color:#999;">${item.category || '非遗'}</span>
                                    <button class="btn-add-mini hover-target" onclick="app.addToCart(event, ${item.id})">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="burst-effect"></div>
                        </div>
                    `;
                    
                    // 绑定点击拆盒事件
                    card.addEventListener('click', (e) => {
                        // 如果点击的是购买按钮，不触发拆盒逻辑（防止冒泡）
                        if (e.target.closest('.btn-add-mini')) return;
                        
                        if (!item.revealed) {
                            this.revealBox(item.id, card);
                        }
                    });

                    grid.appendChild(card);
                });
            }

            // [3. 拆盒逻辑]
            revealBox(id, cardElem) {
                // 1. 更新数据状态
                const product = this.state.products.find(p => p.id === id);
                if(product) product.revealed = true;
                
                // 2. 视觉类名切换
                cardElem.classList.add('is-open');
                
                // 3. 播放粒子动画
                const burst = cardElem.querySelector('.burst-effect');
                burst.style.animation = 'burstAnim 0.8s ease-out';
            }

            // [4. 购物车抛物线动画]
            addToCart(e, id) {
                e.stopPropagation(); // 阻止再次触发卡片点击
                
                // 鉴权
                if (!this.state.currentUser) {
                    alert('请先登录结缘');
                    this.toggleLogin();
                    return;
                }

                const btn = e.target.closest('button');
                const cartIcon = document.querySelector('.icon-btn .fa-shopping-bag');
                
                // 创建飞行小球
                const ball = document.createElement('div');
                ball.className = 'fly-ball';
                document.body.appendChild(ball);
                
                // 计算坐标
                const startRect = btn.getBoundingClientRect();
                const endRect = cartIcon.getBoundingClientRect();
                
                // 初始位置
                ball.style.top = `${startRect.top}px`;
                ball.style.left = `${startRect.left}px`;
                
                // 强制重绘
                ball.offsetHeight; 
                
                // 终点位置
                ball.style.top = `${endRect.top + 10}px`;
                ball.style.left = `${endRect.left + 10}px`;
                ball.style.transform = 'scale(0.2)'; // 飞行中缩小
                
                // 动画结束清理与逻辑
                setTimeout(() => {
                    ball.remove();
                    this.state.cartCount++;
                    document.getElementById('cartBadge').innerText = this.state.cartCount;
                    
                    // 调用API
                    const product = this.state.products.find(p => p.id === id);
                    this.syncCartToApi(product);
                    
                }, 800);
            }

            async syncCartToApi(product) {
                try {
                    await fetch(`${this.API_BASE}/api/cart/add`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            username: this.state.currentUser,
                            product: product
                        })
                    });
                } catch(e) { console.error("Cart sync failed", e); }
            }

            // [5. 辅助功能]
            setupCursor() {
                const dot = document.getElementById('cursor-dot');
                const wash = document.getElementById('cursor-wash');
                
                document.addEventListener('mousemove', (e) => {
                    dot.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`;
                    wash.animate({
                        transform: `translate(${e.clientX}px, ${e.clientY}px)`
                    }, { duration: 500, fill: "forwards" });
                    
                    // 悬停检测
                    const target = e.target;
                    if (target.matches('button, a, .hover-target, .blind-card')) {
                        document.body.classList.add('hover-active');
                    } else {
                        document.body.classList.remove('hover-active');
                    }
                });
            }

            checkSession() {
                const user = localStorage.getItem('currentUser');
                if (user) {
                    this.state.currentUser = user;
                    document.getElementById('userLabel').innerText = user;
                }
            }

            login() {
                const name = document.getElementById('username').value;
                if(name) {
                    this.state.currentUser = name;
                    localStorage.setItem('currentUser', name);
                    document.getElementById('userLabel').innerText = name;
                    this.toggleLogin();
                    alert(`欢迎回来，${name}`);
                }
            }

            toggleLogin() {
                const modal = document.getElementById('loginModal');
                modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            }

            toggleCart() {
                document.getElementById('cartDrawer').classList.toggle('open');
            }

            filter(type, btnElem) {
                this.state.filter = type;
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btnElem.classList.add('active');
                this.renderGrid();
            }

            setupSearch() {
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const val = e.target.value.toLowerCase();
                        this.state.products = this.state.products.filter(p => p.name.includes(val));
                        this.renderGrid();
                    }
                });
            }
        }

        // 启动引擎
        const app = new HeritageApp();
    </script>
</body>
</html>
