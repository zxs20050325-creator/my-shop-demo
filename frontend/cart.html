<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦ - å†€é—ç­‘æ¢¦</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
        }
        
        body { 
            background: #f9f7f4; /* å¥¶ç™½è‰²èƒŒæ™¯ */
            padding-top: 80px; 
            color: #5a5651; /* æš–ç°è‰²æ–‡å­— */
        }
        
        .navbar {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%;
            background: rgba(250, 247, 242, 0.95); /* å¥¶ç™½è‰²åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(10px);
            color: #5a5651; /* æš–ç°è‰² */
            padding: 15px 30px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(139, 76, 48, 0.05); /* æ·±æ£•è‰²ç³»é˜´å½± */
            border-bottom: 1px solid rgba(139, 76, 48, 0.05); /* æ·±æ£•è‰²ç³»è¾¹æ¡† */
        }
        
        .brand-logo { 
            font-size: 22px; 
            font-weight: 400; /* æ›´çº¤ç»†çš„å­—ä½“ */
            color: #8b4c30; /* æ·±æ£•è‰² */
            letter-spacing: 0.5px;
            font-family: 'Georgia', 'serif'; /* æ›´æ¥è¿‘æ‰‹å†™ä½“çš„å­—ä½“ */
        }
        
        .nav-links a { 
            color: #8a8681; /* è¾ƒæµ…çš„æš–ç°è‰² */
            text-decoration: none; 
            margin-left: 20px; 
            font-size: 15px;
            transition: color 0.3s;
        }
        
        .nav-links a:hover { 
            color: #8b4c30; /* æ·±æ£•è‰²æ‚¬åœæ•ˆæœ */
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .page-title { 
            text-align: center; 
            margin-bottom: 40px; 
            color: #5a5651; 
        }
        
        .page-title h2 { 
            font-size: 32px; 
            font-weight: 300; /* æ›´çº¤ç»†çš„å­—ä½“ */
            margin-bottom: 10px; 
            letter-spacing: 0.5px;
            color: #5a5651; /* æš–ç°è‰² */
            font-family: 'Georgia', 'serif'; /* æ‰‹å†™ä½“é£æ ¼ */
        }
        
        .page-title p { 
            color: #a89f96; /* æš–ç°è‰² */
            font-size: 16px; 
            font-weight: 300;
        }
        
        .cart-container {
            background: #fff; /* ç™½è‰²èƒŒæ™¯ */
            border-radius: 8px; /* å‡å°åœ†è§’ï¼Œæ›´ç®€çº¦ */
            overflow: hidden; 
            box-shadow: 0 4px 15px rgba(139, 76, 48, 0.08); /* æ·±æ£•è‰²ç³»è½»å¾®é˜´å½± */
            border: none; /* å»æ‰è¾¹æ¡† */
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .cart-item {
            display: flex;
            padding: 20px 0;
            border-bottom: 1px solid #f0ebe5; /* é™¶åœŸè‰²åˆ†å‰²çº¿ */
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .item-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            background: #faf8f5; /* å¾ˆæµ…çš„å¥¶ç™½è‰² */
            padding: 15px;
            border-radius: 4px;
        }
        
        .item-details {
            flex: 1;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .item-name {
            font-size: 18px;
            font-weight: 400;
            color: #5a5651; /* æš–ç°è‰² */
            margin-bottom: 8px;
        }
        
        .item-price {
            color: #8b4c30; /* æ·±æ£•è‰²ä»·æ ¼ */
            font-size: 20px;
            font-weight: 500;
        }
        
        .item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            border: 1px solid #d9d2ca; /* é™¶åœŸè‰²è¾¹æ¡† */
            border-radius: 6px; /* å‡å°åœ†è§’ */
        }
        
        .quantity-btn {
            background: transparent;
            border: none;
            padding: 8px 15px;
            font-size: 18px;
            color: #8a8681; /* æš–ç°è‰² */
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background: #f0ebe5; /* é™¶åœŸè‰²èƒŒæ™¯ */
            color: #8b4c30; /* æ·±æ£•è‰² */
        }
        
        .quantity-display {
            padding: 8px 10px;
            min-width: 40px;
            text-align: center;
            color: #5a5651; /* æš–ç°è‰² */
        }
        
        .remove-btn {
            background: transparent;
            border: 1px solid #d9d2ca; /* é™¶åœŸè‰²è¾¹æ¡† */
            color: #8a8681; /* æš–ç°è‰² */
            padding: 8px 15px;
            border-radius: 6px; /* å‡å°åœ†è§’ */
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .remove-btn:hover {
            background: #f0ebe5; /* é™¶åœŸè‰²èƒŒæ™¯ */
            color: #8b4c30; /* æ·±æ£•è‰² */
        }
        
        .cart-summary {
            display: flex;
            justify-content: space-between;
            padding: 20px 0;
            border-top: 1px solid #f0ebe5; /* é™¶åœŸè‰²åˆ†å‰²çº¿ */
            margin-top: 10px;
            font-size: 18px;
        }
        
        .total-price {
            color: #8b4c30; /* æ·±æ£•è‰²ä»·æ ¼ */
            font-size: 24px;
            font-weight: 500;
        }
        
        .checkout-btn {
            padding: 15px 30px;
            background: transparent; /* æ‰å¹³è®¾è®¡ */
            color: #8b4c30; /* æ·±æ£•è‰²æ–‡å­— */
            border: 1px solid #d9d2ca; /* é™¶åœŸè‰²è¾¹æ¡† */
            border-radius: 6px; /* å‡å°åœ†è§’ */
            font-size: 18px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }
        
        .checkout-btn:hover {
            background: #f0ebe5; /* é™¶åœŸè‰²æ‚¬åœèƒŒæ™¯ */
            border-color: #c9b7ac; /* æ›´æ·±çš„é™¶åœŸè‰² */
        }
        
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
            color: #bfb8b1; /* æµ…ç°è‰² */
            font-size: 18px;
        }
        
        .empty-cart i {
            font-size: 60px;
            display: block;
            margin-bottom: 20px;
            color: #e8e2db; /* æµ…é™¶åœŸè‰² */
        }
        
        .empty-cart a {
            display: inline-block; 
            margin-top: 20px; 
            padding: 12px 24px; 
            background: transparent; 
            color: #8b4c30; 
            text-decoration: none; 
            border: 1px solid #d9d2ca; 
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .empty-cart a:hover {
            background: #f0ebe5; 
            border-color: #c9b7ac;
        }
        
        @media (max-width: 768px) {
            .navbar {
                padding: 15px;
            }
            
            .cart-item {
                flex-direction: column;
                gap: 15px;
            }
            
            .item-image {
                align-self: center;
                width: 100px;
                height: 100px;
            }
            
            .page-title h2 {
                font-size: 26px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="brand-logo">ğŸ›ï¸ å†€é—ç­‘æ¢¦</div>
        <div class="nav-links" id="auth-section">
            <!-- JSå¡«å…… -->
        </div>
    </nav>

    <div class="container">
        <div class="page-title">
            <h2>æˆ‘çš„è´­ç‰©è½¦</h2>
            <p>æ‚¨æ·»åŠ çš„å•†å“</p>
        </div>

        <div class="cart-container">
            <div id="cart-items">
                <!-- è´­ç‰©è½¦å•†å“å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
            </div>
            
            <div class="cart-summary">
                <div>æ€»è®¡:</div>
                <div class="total-price" id="total-price">Â¥0</div>
            </div>
            
            <button class="checkout-btn" onclick="proceedToCheckout()">å»ç»“ç®—</button>
        </div>
        
        <div class="empty-cart" id="empty-cart" style="display: none;">
            <i>ğŸ›’</i>
            <p>æ‚¨çš„è´­ç‰©è½¦è¿˜æ˜¯ç©ºçš„<br>å¿«å»é¦–é¡µæŒ‘é€‰å¿ƒä»ªçš„å•†å“å§ï¼</p>
            <a href="index.html">å‰å¾€é¦–é¡µ</a>
        </div>
    </div>

    <script>
        const API_BASE = '';
        
        window.onload = function() {
            checkLoginStatus();
            loadCart();
        };

        function checkLoginStatus() {
            const user = localStorage.getItem('currentUser');
            const authSection = document.getElementById('auth-section');
            if (user) {
                authSection.innerHTML = `
                    <span>æ¬¢è¿, ${user}</span>
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="favorites.html">â¤ï¸ æ”¶è—</a>
                    <a onclick="logout()">é€€å‡º</a>
                `;
            } else {
                alert('è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹è´­ç‰©è½¦');
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        async function loadCart() {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const res = await fetch(`/api/cart?username=${user}`);
                const cartItems = await res.json();
                
                const cartItemsDiv = document.getElementById('cart-items');
                const emptyCartDiv = document.getElementById('empty-cart');
                
                if (cartItems.length === 0) {
                    cartItemsDiv.innerHTML = '';
                    emptyCartDiv.style.display = 'block';
                    document.querySelector('.cart-summary').style.display = 'none';
                    document.querySelector('.checkout-btn').style.display = 'none';
                    return;
                }
                
                emptyCartDiv.style.display = 'none';
                document.querySelector('.cart-summary').style.display = 'flex';
                document.querySelector('.checkout-btn').style.display = 'block';
                
                cartItemsDiv.innerHTML = '';

                let totalPrice = 0;
                cartItems.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    totalPrice += itemTotal;
                    
                    cartItemsDiv.innerHTML += `
                        <div class="cart-item">
                            <img src="/images/${item.img.split('/')[1]}" class="item-image" onerror="this.src='https://placehold.co/100x100?text=No+Image'">
                            <div class="item-details">
                                <div class="item-name">${item.name}</div>
                                <div class="item-price">Â¥${item.price}</div>
                            </div>
                            <div class="item-actions">
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
                                    <div class="quantity-display">${item.quantity}</div>
                                    <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
                                </div>
                                <button class="remove-btn" onclick="removeFromCart(${index})">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('total-price').textContent = `Â¥${totalPrice}`;
            } catch (err) {
                console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:', err);
            }
        }

        async function updateQuantity(index, change) {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // è·å–å½“å‰è´­ç‰©è½¦
            const res = await fetch(`/api/cart?username=${user}`);
            const cartItems = await res.json();

            if (cartItems[index]) {
                const newQty = cartItems[index].quantity + change;

                if (newQty <= 0) {
                    // å¦‚æœæ•°é‡å°äºç­‰äº0ï¼Œåˆ™ç§»é™¤å•†å“
                    removeFromCart(index);
                    return;
                }

                // æ›´æ–°æ•°é‡
                cartItems[index].quantity = newQty;

                // é‡æ–°è®¡ç®—æ€»ä»·å¹¶æ›´æ–°UI
                let totalPrice = 0;
                cartItems.forEach(item => {
                    totalPrice += item.price * item.quantity;
                });
                document.getElementById('total-price').textContent = `Â¥${totalPrice}`;

                // é‡æ–°æ¸²æŸ“è´­ç‰©è½¦
                loadCart();
            }
        }

        async function removeFromCart(index) {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            if (!confirm('ç¡®å®šè¦ä»è´­ç‰©è½¦ä¸­åˆ é™¤è¿™ä»¶å•†å“å—ï¼Ÿ')) {
                return;
            }

            try {
                await fetch('/api/cart/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, index: index })
                });
                
                loadCart();
            } catch(e) {
                console.error('åˆ é™¤å¤±è´¥:', e);
            }
        }

        async function proceedToCheckout() {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'login.html';
                return;
            }

            // è·å–å½“å‰è´­ç‰©è½¦
            const res = await fetch(`/api/cart?username=${user}`);
            const cartItems = await res.json();

            if (cartItems.length === 0) {
                alert('è´­ç‰©è½¦ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            // è®¡ç®—æ€»ä»·
            let totalPrice = 0;
            cartItems.forEach(item => {
                totalPrice += item.price * item.quantity;
            });

            // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
            window.location.href = `pay.html?total=${totalPrice}`;
        }
    </script>
</body>
</html>