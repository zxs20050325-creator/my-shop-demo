<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è´­ç‰©è½¦ - å†€é—ç­‘æ¢¦</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FDFBF7; /* æ”¹ä¸ºç±³ç™½è‰²èƒŒæ™¯ï¼Œå¢åŠ è´¨æ„Ÿ */
            color: #333333; /* ä¸»è‰²è°ƒæ”¹ä¸ºå¢¨è‰² */
            padding-top: 80px; 
            line-height: 1.6; 
        }
        
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%;
            background: transparent; /* æ”¹ä¸ºé€æ˜èƒŒæ™¯ */
            color: #333333; /* ä¸»è‰²è°ƒæ”¹ä¸ºå¢¨è‰² */
            padding: 12px 24px; /* å‡å°å¯¼èˆªæ å†…è¾¹è· */
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
            backdrop-filter: blur(10px); /* æ·»åŠ ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
            background-color: rgba(253, 251, 247, 0.8); /* åŠé€æ˜èƒŒæ™¯ */
            border-bottom: none; /* å»æ‰è¾¹æ¡† */
        }
        
        .nav-links a { 
            color: #333333; /* ä¸»è‰²è°ƒæ”¹ä¸ºå¢¨è‰² */
            text-decoration: none; 
            margin-left: 20px; /* å‡å°å¯¼èˆªé¡¹é—´è· */
            font-weight: 400;
            letter-spacing: 1px; /* å‡å°å­—é—´è· */
            transition: opacity 0.2s ease;
            font-size: 14px; /* å‡å°å­—ä½“å¤§å° */
        }
        .nav-links a:hover { 
            opacity: 0.7; /* æ‚¬åœæ—¶ä»…æ”¹å˜é€æ˜åº¦ */
            color: #5a7d7c; /* æ”¹ä¸ºé»›è“è‰² */
        }
        
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 30px 20px; /* å‡å°å†…è¾¹è· */
        }
        
        .cart-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
        }
        
        .cart-item { 
            background: transparent; /* å»æ‰èƒŒæ™¯ */
            padding: 20px 0; /* å‡å°‘å†…è¾¹è· */
            display: flex; 
            align-items: center; 
            border-bottom: 1px solid #e2e8f0; /* æ›´æ·¡çš„åˆ†éš”çº¿ */
        }
        
        /* å›¾ç‰‡é˜²å˜å½¢å¤„ç† */
        .cart-img { 
            width: 120px; 
            height: 120px; 
            object-fit: contain; 
            margin-right: 25px; 
            border-radius: 8px; /* å¢åŠ åœ†è§’ */
        }
        
        .item-details { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        .item-name { 
            font-size: 18px; 
            font-weight: 400; /* ä¸å†åŠ ç²— */
            color: #333333; /* å¢åŠ é¢œè‰²æ·±åº¦ */
            font-family: 'Noto Serif SC', 'Songti SC', serif; /* ä½¿ç”¨è¡¬çº¿ä½“ */
        }
        
        .item-price { 
            color: #5a7d7c; /* æ”¹ä¸ºé»›è“è‰²ä»·æ ¼ */
            font-size: 18px; 
            font-weight: 400; /* ä¸å†åŠ ç²— */
        }
        
        .item-controls { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-left: 20px; 
        }
        
        .quantity-btn { 
            width: 32px; 
            height: 32px; 
            border: 1px solid #333333; 
            background: transparent; /* æ”¹ä¸ºé€æ˜èƒŒæ™¯ */
            color: #333333; 
            border-radius: 0; /* å»æ‰åœ†è§’ */
            cursor: pointer; 
            font-size: 16px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        
        .quantity-display { 
            font-size: 16px; 
            min-width: 30px; 
            text-align: center; 
        }
        
        .remove-btn { 
            padding: 8px 16px; 
            background: #333333; 
            color: white; 
            border: none; 
            border-radius: 0; /* å»æ‰åœ†è§’ */
            cursor: pointer; 
            font-size: 14px; 
            margin-left: 15px;
            transition: opacity 0.2s ease;
        }
        
        .remove-btn:hover { 
            opacity: 0.9; 
        }
        
        .cart-total { 
            margin: 30px 0; 
            padding: 20px; 
            background: transparent; /* å»æ‰èƒŒæ™¯ */
            border: 1px solid #333333; /* å¢¨è‰²è¾¹æ¡† */
            border-radius: 0; /* å»æ‰åœ†è§’ */
            font-size: 18px; 
            display: flex; 
            justify-content: space-between; 
        }
        
        .checkout-btn { 
            width: 100%; 
            padding: 14px; 
            background: #333333; 
            color: white; 
            border: none; 
            border-radius: 0; /* å»æ‰åœ†è§’ */
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 400;
            transition: opacity 0.2s ease;
        }
        
        .checkout-btn:hover { 
            opacity: 0.9; 
        }
        
        .empty-cart { 
            text-align: center; 
            padding: 60px 20px; 
            color: #a0aec0; 
            font-size: 18px; 
        }
        
        .back-link {
            display: inline-block;
            padding: 10px 16px; /* å‡å°å†…è¾¹è· */
            background: transparent; /* æ”¹ä¸ºé€æ˜èƒŒæ™¯ */
            color: #333333; /* å¢¨è‰²æ–‡å­— */
            text-decoration: none;
            border: 1px solid #333333; /* å¢¨è‰²è¾¹æ¡† */
            border-radius: 0; /* å»æ‰åœ†è§’ */
            transition: all 0.2s ease;
            margin-bottom: 20px;
        }
        .back-link:hover {
            background: #333333;
            color: white;
        }
        
        @media (max-width: 768px) {
            .cart-item { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 15px; 
            }
            .cart-img { 
                width: 100px; 
                height: 100px; 
                margin-right: 0; 
            }
            .item-controls { 
                width: 100%; 
                justify-content: space-between; 
                margin-left: 0; 
            }
            .container { padding: 20px 15px; }
            .navbar { padding: 12px 16px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div style="font-size: 18px; font-weight: 500; color: #333333; font-family: 'Noto Serif SC', 'Songti SC', serif;">ğŸ›ï¸ å†€é—ç­‘æ¢¦</div>
        <div class="nav-links" id="auth-section">
            <!-- JSå¡«å…… -->
        </div>
    </nav>

    <div class="container">
        <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        
        <div class="cart-header">
            <h2>æˆ‘çš„è´­ç‰©è½¦</h2>
            <div id="item-count">å…± <span id="count-value">0</span> ä»¶å•†å“</div>
        </div>
        
        <div id="cart-items"></div>
        
        <div id="empty-cart-message" class="empty-cart" style="display: none;">
            è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿï¼Œè¯·å‰å¾€é¦–é¡µé€‰è´­å•†å“
        </div>
        
        <div class="cart-total">
            <strong>æ€»è®¡:</strong>
            <span id="total-price">Â¥0.00</span>
        </div>
        
        <button class="checkout-btn" onclick="proceedToPay()">ç«‹å³ç»“ç®—</button>
    </div>

    <script>
        // è®¾ç½®APIåŸºç¡€URLï¼Œä»¥ä¾¿åœ¨éƒ¨ç½²æ—¶è°ƒæ•´
        const isDeployed = window.location.hostname.includes('onrender.com');
        // ä¿®æ”¹ä¸ºå®é™…çš„åç«¯æœåŠ¡åœ°å€
        const API_BASE = isDeployed ? 'https://jiyi-zhumeng.onrender.com' : 'http://localhost:3000';

        window.onload = function() {
            checkLoginStatus();
            loadCartItems();
            trackUserAction('è®¿é—®è´­ç‰©è½¦', '-');
        };

        function checkLoginStatus() {
            const user = localStorage.getItem('currentUser');
            const authSection = document.getElementById('auth-section');
            if (user) {
                authSection.innerHTML = `
                    <span style="margin-right: 20px;">æ¬¢è¿, ${user}</span>
                    <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                    <a href="favorites.html">â¤ï¸ æ”¶è—</a>
                    <a onclick="logout()">é€€å‡º</a>
                `;
            } else {
                authSection.innerHTML = `
                    <a href="login.html">ç™»å½•</a>
                    <a href="register.html">æ³¨å†Œ</a>
                `;
            }
        }

        function logout() {
            trackUserAction('ç”¨æˆ·ç™»å‡º', '-');
            localStorage.removeItem('currentUser');
            window.location.reload();
        }

        async function loadCartItems() {
            const user = localStorage.getItem('currentUser');
            if(!user) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'login.html';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/cart?username=${encodeURIComponent(user)}`);
                const items = await res.json();
                
                if(items.length === 0) {
                    document.getElementById('cart-items').style.display = 'none';
                    document.getElementById('empty-cart-message').style.display = 'block';
                    document.getElementById('count-value').textContent = '0';
                    document.getElementById('total-price').textContent = 'Â¥0.00';
                    return;
                }

                document.getElementById('cart-items').style.display = 'block';
                document.getElementById('empty-cart-message').style.display = 'none';
                
                document.getElementById('cart-items').innerHTML = '';
                let total = 0;
                let count = 0;

                items.forEach((item, index) => {
                    const itemTotal = item.product.price * item.quantity;
                    total += itemTotal;
                    count += item.quantity;

                    // å¤„ç†å›¾ç‰‡URL
                    let imgSrc = item.product.img;
                    if (!imgSrc.startsWith('http') && !imgSrc.startsWith('/')) {
                        imgSrc = `${API_BASE}/${imgSrc}`;
                    }

                    document.getElementById('cart-items').innerHTML += `
                        <div class="cart-item">
                            <img src="${imgSrc}" alt="${item.product.name}" class="cart-img">
                            <div class="item-details">
                                <div class="item-name">${item.product.name}</div>
                                <div class="item-price">å•ä»·: Â¥${item.product.price}</div>
                            </div>
                            <div class="item-controls">
                                <button class="quantity-btn" onclick="updateQuantity(${item.product.id}, ${item.quantity - 1})">-</button>
                                <span class="quantity-display">${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateQuantity(${item.product.id}, ${item.quantity + 1})">+</button>
                                <button class="remove-btn" onclick="removeFromCart(${item.product.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('count-value').textContent = count;
                document.getElementById('total-price').textContent = `Â¥${total.toFixed(2)}`;
            } catch (err) { 
                console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:', err);
                alert('è´­ç‰©è½¦åŠ è½½å¤±è´¥');
            }
        }

        async function updateQuantity(productId, newQuantity) {
            if(newQuantity < 1) return; // æ•°é‡ä¸èƒ½å°äº1
            
            const user = localStorage.getItem('currentUser');
            if(!user) return;

            try {
                const res = await fetch(`${API_BASE}/api/cart/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: user, 
                        productId: productId,
                        quantity: newQuantity
                    })
                });
                const data = await res.json();
                
                if(data.success) {
                    loadCartItems(); // é‡æ–°åŠ è½½è´­ç‰©è½¦
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch(e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        async function removeFromCart(productId) {
            const user = localStorage.getItem('currentUser');
            if(!user) return;

            if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»¶å•†å“å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`${API_BASE}/api/cart/remove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: user, 
                        productId: productId
                    })
                });
                const data = await res.json();
                
                if(data.success) {
                    loadCartItems(); // é‡æ–°åŠ è½½è´­ç‰©è½¦
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch(e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        function proceedToPay() {
            const user = localStorage.getItem('currentUser');
            if(!user) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'login.html';
                return;
            }

            // æ£€æŸ¥è´­ç‰©è½¦æ˜¯å¦ä¸ºç©º
            const totalPrice = parseFloat(document.getElementById('total-price').textContent.replace('Â¥', ''));
            if(totalPrice <= 0) {
                alert('è´­ç‰©è½¦ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
            window.location.href = 'pay.html';
        }

        function trackUserAction(action, product) {
            const user = localStorage.getItem('currentUser');
            fetch(`${API_BASE}/api/track`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, action, product })
            }).catch(() => {}); // å¿½ç•¥é”™è¯¯
        }
    </script>
</body>
</html>