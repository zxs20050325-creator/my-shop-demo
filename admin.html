<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“æµè§ˆè®°å½•ç›‘æ§å¹³å°ï¼ˆä»…çœŸå®æ•°æ®ï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'å¾®è½¯é›…é»‘', sans-serif; }
        body { background-color: #f0f2f5; color: #333; padding: 20px 0; }
        .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb; }
        .header h1 { color: #1f2937; font-size: 28px; }
        .control-btn { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        .control-btn:hover { background: #1d4ed8; }
        .auto-refresh { margin-left: 10px; background: #10b981; }
        .auto-refresh.stop { background: #ef4444; }

        /* KPIæŒ‡æ ‡åŒº */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; border-radius: 12px; padding: 25px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; transition: transform 0.3s; }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-value { font-size: 36px; font-weight: 700; color: #2563eb; margin: 15px 0 5px; }
        .kpi-label { font-size: 14px; color: #6b7280; }

        /* å›¾è¡¨ç½‘æ ¼ */
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        .chart-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chart-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1f2937; }
        .chart-container { width: 100%; height: 350px; position: relative; }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-container { height: 250px; }
        }
        @media (max-width: 480px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 22px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <h1>å•†å“æµè§ˆè®°å½•ç›‘æ§å¹³å°ï¼ˆä»…çœŸå®æ•°æ®ï¼‰</h1>
            <div>
                <button class="control-btn" onclick="fetchBrowseStats()">ğŸ”„ ç«‹å³åˆ·æ–°</button>
                <button class="control-btn auto-refresh" onclick="toggleAutoRefresh()" id="auto-refresh-btn">âš¡ è‡ªåŠ¨åˆ·æ–°ï¼ˆå¼€ï¼‰</button>
            </div>
        </div>

        <!-- KPIæ ¸å¿ƒæŒ‡æ ‡ -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">æ€»æµè§ˆé‡</div>
                <div class="kpi-value" id="total-browse">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">ä»Šæ—¥æµè§ˆé‡</div>
                <div class="kpi-value" id="today-browse">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">çƒ­é—¨å•†å“</div>
                <div class="kpi-value" id="hot-product">æš‚æ— </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">å¹³å‡åœç•™æ—¶é—´ï¼ˆç§’ï¼‰</div>
                <div class="kpi-value" id="avg-stay-time">0</div>
            </div>
        </div>

        <!-- å›¾è¡¨å±•ç¤ºåŒº -->
        <div class="chart-grid">
            <!-- 1. 24å°æ—¶æµè§ˆè¶‹åŠ¿ï¼ˆæŠ˜çº¿å›¾ï¼‰ -->
            <div class="chart-card">
                <div class="chart-title">24å°æ—¶æµè§ˆé‡è¶‹åŠ¿</div>
                <div class="chart-container">
                    <canvas id="hourly-trend-chart"></canvas>
                </div>
            </div>

            <!-- 2. å•†å“æµè§ˆå æ¯”ï¼ˆé¥¼å›¾ï¼‰ -->
            <div class="chart-card">
                <div class="chart-title">å•†å“æµè§ˆå æ¯”</div>
                <div class="chart-container">
                    <canvas id="product-ratio-chart"></canvas>
                </div>
            </div>

            <!-- 3. è¿‘7å¤©æµè§ˆé‡ï¼ˆæŸ±çŠ¶å›¾ï¼‰ -->
            <div class="chart-card full-width">
                <div class="chart-title">è¿‘7å¤©æµè§ˆé‡è¶‹åŠ¿</div>
                <div class="chart-container">
                    <canvas id="daily-trend-chart"></canvas>
                </div>
            </div>

            <!-- 4. çƒ­é—¨å•†å“TOP5ï¼ˆæ¨ªå‘æŸ±çŠ¶å›¾ï¼‰ -->
            <div class="chart-card full-width">
                <div class="chart-title">çƒ­é—¨å•†å“æµè§ˆé‡TOP5</div>
                <div class="chart-container">
                    <canvas id="hot-products-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å¿…æ”¹ï¼šæ›¿æ¢ä¸ºä½ çš„RenderåŸŸå ==========
        const API_BASE = 'https://my-shop-demo.onrender.com'; 
        // ==================================================

        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        let charts = {};
        let autoRefreshTimer = setInterval(fetchBrowseStats, 5000); // 5ç§’è‡ªåŠ¨åˆ·æ–°
        let isAutoRefresh = true;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å›¾è¡¨+è·å–çœŸå®æ•°æ®
        window.onload = () => {
            initCharts();
            fetchBrowseStats();
        };

        // 1. åˆå§‹åŒ–å›¾è¡¨é…ç½®
        function initCharts() {
            // 1.1 24å°æ—¶æµè§ˆè¶‹åŠ¿ï¼ˆæŠ˜çº¿å›¾ï¼‰
            const hourlyCtx = document.getElementById('hourly-trend-chart').getContext('2d');
            charts.hourly = new Chart(hourlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æµè§ˆé‡',
                        data: [],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // 1.2 å•†å“æµè§ˆå æ¯”ï¼ˆé¥¼å›¾ï¼‰
            const productRatioCtx = document.getElementById('product-ratio-chart').getContext('2d');
            charts.productRatio = new Chart(productRatioCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#2563eb', '#f97316', '#10b981', '#8b5cf6', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 1.3 è¿‘7å¤©æµè§ˆé‡ï¼ˆæŸ±çŠ¶å›¾ï¼‰
            const dailyCtx = document.getElementById('daily-trend-chart').getContext('2d');
            charts.daily = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æµè§ˆé‡',
                        data: [],
                        backgroundColor: 'rgba(37, 99, 235, 0.7)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });

            // 1.4 çƒ­é—¨å•†å“TOP5ï¼ˆæ¨ªå‘æŸ±çŠ¶å›¾ï¼‰
            const hotProductsCtx = document.getElementById('hot-products-chart').getContext('2d');
            charts.hotProducts = new Chart(hotProductsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æµè§ˆé‡',
                        data: [],
                        backgroundColor: (context) => {
                            const value = context.dataset.data[context.dataIndex];
                            const alpha = Math.min(0.9, 0.2 + (value / (Math.max(...context.dataset.data) || 1)));
                            return `rgba(37, 99, 235, ${alpha})`;
                        },
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y', // æ¨ªå‘æŸ±çŠ¶å›¾
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // 2. ä»…åŠ è½½çœŸå®æ•°æ®ï¼ˆæ— æ¨¡æ‹Ÿå…œåº•ï¼‰
        async function fetchBrowseStats() {
            try {
                const response = await fetch(`${API_BASE}/api/browse-stats`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors'
                });
                const data = await response.json();
                
                // æ›´æ–°é¡µé¢çœŸå®æ•°æ®
                updateKPIs(data.kpis);    
                updateCharts(data.charts); 
                console.log('âœ… åŠ è½½çœŸå®æµè§ˆæ•°æ®ï¼š', data);
            } catch (error) {
                console.error('âŒ è·å–çœŸå®æ•°æ®å¤±è´¥ï¼š', error);
                // å¼‚å¸¸æ—¶æ˜¾ç¤ºç©ºæ•°æ®
                const emptyData = {
                    kpis: { totalBrowse: 0, todayBrowse: 0, hotProduct: 'æš‚æ— ', avgStayTime: 0 },
                    charts: {
                        hourlyTrend: { labels: [], data: [] },
                        productRatio: { labels: [], data: [] },
                        dailyTrend: { labels: [], data: [] },
                        hotProducts: { labels: [], data: [] }
                    }
                };
                updateKPIs(emptyData.kpis);
                updateCharts(emptyData.charts);
            }
        }

        // 3. æ›´æ–°KPIæŒ‡æ ‡ï¼ˆä»…çœŸå®æ•°æ®ï¼‰
        function updateKPIs(kpiData) {
            document.getElementById('total-browse').innerText = kpiData.totalBrowse;
            document.getElementById('today-browse').innerText = kpiData.todayBrowse;
            document.getElementById('hot-product').innerText = kpiData.hotProduct;
            document.getElementById('avg-stay-time').innerText = kpiData.avgStayTime;
        }

        // 4. æ›´æ–°å›¾è¡¨æ•°æ®ï¼ˆä»…çœŸå®æ•°æ®ï¼‰
        function updateCharts(chartData) {
            // 24å°æ—¶è¶‹åŠ¿
            charts.hourly.data.labels = chartData.hourlyTrend.labels;
            charts.hourly.data.datasets[0].data = chartData.hourlyTrend.data;
            charts.hourly.update();

            // å•†å“å æ¯”
            charts.productRatio.data.labels = chartData.productRatio.labels;
            charts.productRatio.data.datasets[0].data = chartData.productRatio.data;
            charts.productRatio.update();

            // è¿‘7å¤©è¶‹åŠ¿
            charts.daily.data.labels = chartData.dailyTrend.labels;
            charts.daily.data.datasets[0].data = chartData.dailyTrend.data;
            charts.daily.update();

            // çƒ­é—¨å•†å“
            charts.hotProducts.data.labels = chartData.hotProducts.labels;
            charts.hotProducts.data.datasets[0].data = chartData.hotProducts.data;
            charts.hotProducts.update();
        }

        // 5. åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            if (isAutoRefresh) {
                clearInterval(autoRefreshTimer);
                btn.innerText = 'âš¡ è‡ªåŠ¨åˆ·æ–°ï¼ˆå…³ï¼‰';
                btn.classList.add('stop');
            } else {
                autoRefreshTimer = setInterval(fetchBrowseStats, 5000);
                btn.innerText = 'âš¡ è‡ªåŠ¨åˆ·æ–°ï¼ˆå¼€ï¼‰';
                btn.classList.remove('stop');
            }
            isAutoRefresh = !isAutoRefresh;
        }
    </script>
</body>
</html>
