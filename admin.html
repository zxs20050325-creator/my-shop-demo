<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“æµè§ˆè®°å½•ç›‘æ§å¹³å°ï¼ˆä»…çœŸå®æ•°æ®ï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'å¾®è½¯é›…é»‘', sans-serif; }
        body { background-color: #f0f2f5; color: #333; padding: 20px 0; }
        .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb; }
        .header h1 { color: #1f2937; font-size: 28px; }
        .control-btn {
            background: #2563eb; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-size: 16px; transition: background 0.3s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .control-btn:hover:not(:disabled) { background: #1d4ed8; }
        .control-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .auto-refresh { background: #10b981; }
        .auto-refresh.stop { background: #ef4444; }

        /* KPIæŒ‡æ ‡åŒº */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; border-radius: 12px; padding: 25px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; transition: transform 0.3s; }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-value { font-size: 36px; font-weight: 700; color: #2563eb; margin: 15px 0 5px; }
        .kpi-label { font-size: 14px; color: #6b7280; }

        /* å›¾è¡¨ç½‘æ ¼ */
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px; position: relative; }
        .full-width { grid-column: 1 / -1; }
        .chart-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
        .chart-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1f2937; }
        .chart-container { width: 100%; height: 350px; position: relative; }
        .empty-tip {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #999; font-size: 16px; text-align: center;
            width: 100%;
            display: none;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            .chart-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .chart-container { height: 250px; }
        }
        @media (max-width: 480px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 22px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <h1>å•†å“æµè§ˆè®°å½•ç›‘æ§å¹³å°ï¼ˆä»…çœŸå®æ•°æ®ï¼‰</h1>
            <div>
                <button class="control-btn" id="refresh-btn" onclick="fetchBrowseStats()">ğŸ”„ ç«‹å³åˆ·æ–°</button>
                <button class="control-btn auto-refresh" onclick="toggleAutoRefresh()" id="auto-refresh-btn">âš¡ è‡ªåŠ¨åˆ·æ–°ï¼ˆå¼€ï¼‰</button>
            </div>
        </div>

        <!-- KPIæ ¸å¿ƒæŒ‡æ ‡ -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">æ€»æµè§ˆé‡</div>
                <div class="kpi-value" id="total-browse">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">ä»Šæ—¥æµè§ˆé‡</div>
                <div class="kpi-value" id="today-browse">0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">çƒ­é—¨å•†å“</div>
                <div class="kpi-value" id="hot-product">æš‚æ— </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">å¹³å‡åœç•™æ—¶é—´ï¼ˆç§’ï¼‰</div>
                <div class="kpi-value" id="avg-stay-time">0</div>
            </div>
        </div>

        <!-- å›¾è¡¨å±•ç¤ºåŒº -->
        <div class="chart-grid">
            <!-- 1. 24å°æ—¶æµè§ˆè¶‹åŠ¿ -->
            <div class="chart-card">
                <div class="chart-title">24å°æ—¶æµè§ˆé‡è¶‹åŠ¿</div>
                <div class="chart-container">
                    <canvas id="hourly-trend-chart"></canvas>
                    <div class="empty-tip" id="hourly-empty">æš‚æ— 24å°æ—¶æµè§ˆæ•°æ®</div>
                </div>
            </div>

            <!-- 2. å•†å“æµè§ˆå æ¯” -->
            <div class="chart-card">
                <div class="chart-title">å•†å“æµè§ˆå æ¯”</div>
                <div class="chart-container">
                    <canvas id="product-ratio-chart"></canvas>
                    <div class="empty-tip" id="ratio-empty">æš‚æ— å•†å“æµè§ˆæ•°æ®</div>
                </div>
            </div>

            <!-- 3. è¿‘7å¤©æµè§ˆé‡ -->
            <div class="chart-card full-width">
                <div class="chart-title">è¿‘7å¤©æµè§ˆé‡è¶‹åŠ¿</div>
                <div class="chart-container">
                    <canvas id="daily-trend-chart"></canvas>
                    <div class="empty-tip" id="daily-empty">æš‚æ— 7å¤©æµè§ˆæ•°æ®</div>
                </div>
            </div>

            <!-- 4. çƒ­é—¨å•†å“TOP5 -->
            <div class="chart-card full-width">
                <div class="chart-title">çƒ­é—¨å•†å“æµè§ˆé‡TOP5</div>
                <div class="chart-container">
                    <canvas id="hot-products-chart"></canvas>
                    <div class="empty-tip" id="hot-empty">æš‚æ— çƒ­é—¨å•†å“æ•°æ®</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€çŠ¶æ€ ==========
        let charts = {};
        let autoRefreshTimer = null;
        let isAutoRefresh = true;
        let isFetching = false;
        let chartsInitialized = false;

        // ========== å·¥å…·å‡½æ•° ==========
        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 137.5) % 360; // é»„é‡‘è§’ï¼Œè§†è§‰å‡åŒ€
                colors.push(`hsl(${hue}, 70%, 60%)`);
            }
            return colors;
        }

        function setLoading(isLoading) {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = isLoading;
            btn.innerHTML = isLoading ? 'ğŸ”„ åŠ è½½ä¸­...' : 'ğŸ”„ ç«‹å³åˆ·æ–°';
        }

        function showEmptyTip(chartId, isEmpty) {
            const tip = document.getElementById(`${chartId}-empty`);
            if (tip) tip.style.display = isEmpty ? 'block' : 'none';
        }

        // ========== å›¾è¡¨åˆå§‹åŒ– ==========
        function initCharts() {
            if (chartsInitialized) return;

            const hourlyCtx = document.getElementById('hourly-trend-chart').getContext('2d');
            charts.hourly = new Chart(hourlyCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'æµè§ˆé‡', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', borderWidth: 2, tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });

            const productRatioCtx = document.getElementById('product-ratio-chart').getContext('2d');
            charts.productRatio = new Chart(productRatioCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom' } } }
            });

            const dailyCtx = document.getElementById('daily-trend-chart').getContext('2d');
            charts.daily = new Chart(dailyCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'æµè§ˆé‡', data: [], backgroundColor: 'rgba(37, 99, 235, 0.7)', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });

            const hotProductsCtx = document.getElementById('hot-products-chart').getContext('2d');
            charts.hotProducts = new Chart(hotProductsCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'æµè§ˆé‡', data: [], backgroundColor: (ctx) => {
                    const data = ctx.dataset.data;
                    const max = Math.max(...data);
                    const value = data[ctx.dataIndex];
                    const alpha = max ? 0.2 + (value / max) * 0.7 : 0.5;
                    return `rgba(37, 99, 235, ${alpha})`;
                }, borderRadius: 6 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });

            chartsInitialized = true;
        }

        // ========== æ•°æ®è·å–ä¸æ›´æ–° ==========
        async function fetchBrowseStats() {
            if (isFetching) return;
            isFetching = true;
            setLoading(true);

            try {
                const response = await fetch('/api/browse-stats'); // â† å…³é”®ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                updateKPIs(data.kpis);
                updateCharts(data.charts);
                console.log('âœ… åŠ è½½çœŸå®æµè§ˆæ•°æ®ï¼š', data);
            } catch (error) {
                console.error('âŒ è·å–çœŸå®æ•°æ®å¤±è´¥ï¼š', error);
                // æ¸…ç©ºæ•°æ®
                updateKPIs({ totalBrowse: 0, todayBrowse: 0, hotProduct: 'æš‚æ— ', avgStayTime: 0 });
                updateCharts({
                    hourlyTrend: { labels: [], data: [] },
                    productRatio: { labels: [], data: [] },
                    dailyTrend: { labels: [], data: [] },
                    hotProducts: { labels: [], data: [] }
                });
            } finally {
                isFetching = false;
                setLoading(false);
            }
        }

        function updateKPIs(kpiData) {
            document.getElementById('total-browse').innerText = kpiData.totalBrowse || 0;
            document.getElementById('today-browse').innerText = kpiData.todayBrowse || 0;
            document.getElementById('hot-product').innerText = kpiData.hotProduct || 'æš‚æ— ';
            document.getElementById('avg-stay-time').innerText = (kpiData.avgStayTime || 0).toFixed(1);
        }

        function updateCharts(chartData) {
            // 24å°æ—¶è¶‹åŠ¿
            charts.hourly.data.labels = chartData.hourlyTrend?.labels || [];
            charts.hourly.data.datasets[0].data = chartData.hourlyTrend?.data || [];
            charts.hourly.update();
            showEmptyTip('hourly', !chartData.hourlyTrend?.labels?.length);

            // å•†å“å æ¯”
            const ratioLabels = chartData.productRatio?.labels || [];
            const ratioData = chartData.productRatio?.data || [];
            charts.productRatio.data.labels = ratioLabels;
            charts.productRatio.data.datasets[0].data = ratioData;
            charts.productRatio.data.datasets[0].backgroundColor = generateColors(ratioLabels.length);
            charts.productRatio.update();
            showEmptyTip('ratio', !ratioLabels.length);

            // è¿‘7å¤©è¶‹åŠ¿
            charts.daily.data.labels = chartData.dailyTrend?.labels || [];
            charts.daily.data.datasets[0].data = chartData.dailyTrend?.data || [];
            charts.daily.update();
            showEmptyTip('daily', !chartData.dailyTrend?.labels?.length);

            // çƒ­é—¨å•†å“
            charts.hotProducts.data.labels = chartData.hotProducts?.labels || [];
            charts.hotProducts.data.datasets[0].data = chartData.hotProducts?.data || [];
            charts.hotProducts.update();
            showEmptyTip('hot', !chartData.hotProducts?.labels?.length);
        }

        // ========== è‡ªåŠ¨åˆ·æ–°æ§åˆ¶ ==========
        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            if (isAutoRefresh) {
                clearInterval(autoRefreshTimer);
                btn.innerText = 'âš¡ è‡ªåŠ¨åˆ·æ–°ï¼ˆå…³ï¼‰';
                btn.classList.add('stop');
            } else {
                autoRefreshTimer = setInterval(fetchBrowseStats, 5000);
                btn.innerText = 'âš¡ è‡ªåŠ¨åˆ·æ–°ï¼ˆå¼€ï¼‰';
                btn.classList.remove('stop');
            }
            isAutoRefresh = !isAutoRefresh;
        }

        // ========== é¡µé¢åŠ è½½ ==========
        window.onload = () => {
            initCharts();
            fetchBrowseStats();
            autoRefreshTimer = setInterval(fetchBrowseStats, 5000);
        };

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨ï¼ˆå¯é€‰ï¼Œæå‡å†…å­˜å®‰å…¨ï¼‰
        window.onbeforeunload = () => {
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        };
    </script>
</body>
</html>
