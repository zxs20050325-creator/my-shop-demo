<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å•†åŸæ•°æ®é©¾é©¶èˆ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f7fe; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; margin: 0; padding: 20px; color: #2b3674; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .controls button { border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-refresh { background: #4318ff; color: white; }
        .btn-auto { background: #fff; color: #4318ff; }
        .btn-clear { background: #fff0f0; color: #e31a1a; }
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; }
        .card-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .icon-blue { background: #f4f7fe; color: #4318ff; } .icon-green { background: #e6fdf2; color: #05cd99; } .icon-orange { background: #fff8f0; color: #ff9f43; }
        .card-info h3 { margin: 0; color: #a3aed0; font-size: 14px; font-weight: 500; }
        .card-info h2 { margin: 5px 0 0 0; font-size: 32px; font-weight: 700; color: #2b3674; }
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); height: 400px; position: relative; }
        .chart-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; }
        .table-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #a3aed0; font-weight: 500; border-bottom: 1px solid #f0f0f0; padding: 15px; }
        td { padding: 15px; border-bottom: 1px solid #f8f9fa; color: #2b3674; font-weight: 500; }
        .badge { padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; }
        .badge-view { background: #f4f7fe; color: #4318ff; } .badge-cart { background: #fff8f0; color: #ff9f43; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation { 0% { box-shadow: 0 0 0 0 rgba(67, 24, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(67, 24, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(67, 24, 255, 0); } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div><h3 style="margin:0; color:#a3aed0;">Admin Dashboard</h3><h1>å•†åŸè¿è¥æ•°æ®é©¾é©¶èˆ±</h1></div>
            <div class="controls"><button class="btn-refresh" onclick="fetchLogs()">ğŸ”„ ç«‹å³åˆ·æ–°</button><button class="btn-auto" onclick="toggleAuto()" id="auto-btn">âš¡ è‡ªåŠ¨åˆ·æ–°: å…³</button><button class="btn-clear" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©º</button></div>
        </div>
        <div class="kpi-grid">
            <div class="card"><div class="card-icon icon-blue">ğŸ‘¥</div><div class="card-info"><h3>å®æ—¶è®¿é—®äººæ¬¡</h3><h2 id="kpi-views">0</h2></div></div>
            <div class="card"><div class="card-icon icon-green">ğŸ’°</div><div class="card-info"><h3>æ„å‘é”€å”®é¢</h3><h2 id="kpi-money">Â¥0</h2></div></div>
            <div class="card"><div class="card-icon icon-orange">ğŸ›’</div><div class="card-info"><h3>è½¬åŒ–ç‡</h3><h2 id="kpi-rate">0%</h2></div></div>
        </div>
        <div class="charts-grid">
            <div class="chart-card"><div class="chart-title">æµé‡è¶‹åŠ¿</div><div style="height: 320px; width: 100%;"><canvas id="lineChart"></canvas></div></div>
            <div class="chart-card"><div class="chart-title">è¡Œä¸ºåˆ†å¸ƒ</div><div style="height: 300px; width: 100%; display:flex; justify-content:center;"><canvas id="pieChart"></canvas></div></div>
        </div>
        <div class="table-card">
            <div class="chart-title">è¯¦ç»†æ—¥å¿—</div>
            <table><thead><tr><th width="15%">æ—¶é—´</th><th width="15%">ç”¨æˆ·</th><th width="15%">è¡Œä¸º</th><th>è¯¦æƒ…</th></tr></thead><tbody id="log-list"></tbody></table>
        </div>
    </div>
    <script>
        const ctxLine = document.getElementById('lineChart').getContext('2d');
        const lineChart = new Chart(ctxLine, { type: 'line', data: { labels: [], datasets: [{ label: 'æ´»è·ƒåº¦', data: [], borderColor: '#4318ff', backgroundColor: 'rgba(67, 24, 255, 0.1)', borderWidth: 3, tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true } } } });
        const ctxPie = document.getElementById('pieChart').getContext('2d');
        const pieChart = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['æµè§ˆ', 'åŠ è´­'], datasets: [{ data: [0, 0], backgroundColor: ['#eff4fb', '#4318ff'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } } });

        // ====================================================
        // ğŸ”´ å…³é”®æ­¥éª¤ï¼šç­‰ä½  Render éƒ¨ç½²å¥½åï¼ŒæŠŠç½‘å€å¡«åœ¨ä¸‹é¢
        // ====================================================
        const API = 'http://localhost:3000/api/admin';

        async function fetchLogs() {
            try {
                const res = await fetch(`${API}/logs`);
                const logs = await res.json();
                updateKPI(logs); updateCharts(logs); renderTable(logs);
            } catch (e) { console.error("è¿æ¥å¤±è´¥"); }
        }
        function updateKPI(logs) {
            let views=0, carts=0, money=0;
            logs.forEach(l => { if(l.action==='è®¿é—®é¡µé¢') views++; if(l.action==='åŠ å…¥è´­ç‰©è½¦'){ carts++; const m=l.detail.match(/Â¥(\d+)/); if(m) money+=parseInt(m[1]); } });
            document.getElementById('kpi-views').innerText=views; document.getElementById('kpi-money').innerText='Â¥'+money.toLocaleString();
            document.getElementById('kpi-rate').innerText=(views>0?((carts/views)*100).toFixed(1):0)+'%';
        }
        function updateCharts(logs) {
            const sorted = [...logs].reverse().slice(-15);
            lineChart.data.labels = sorted.map(l => l.time);
            lineChart.data.datasets[0].data = sorted.map((_, i) => i + 1 + (Math.random()*2));
            lineChart.update();
            let v=0, c=0; logs.forEach(l=>{ if(l.action==='è®¿é—®é¡µé¢')v++; if(l.action==='åŠ å…¥è´­ç‰©è½¦')c++; });
            pieChart.data.datasets[0].data = [v, c]; pieChart.update();
        }
        function renderTable(logs) {
            const tbody = document.getElementById('log-list');
            if(logs.length===0){ tbody.innerHTML='<tr><td colspan="4" style="text-align:center;padding:20px;">æš‚æ— æ•°æ®</td></tr>'; return; }
            let html=''; logs.slice(0,10).forEach(l=>{ 
                let b=l.action==='åŠ å…¥è´­ç‰©è½¦'?'badge-cart':'badge-view';
                html+=`<tr><td>${l.time}</td><td>${l.user}</td><td><span class="badge ${b}">${l.action}</span></td><td>${l.detail}</td></tr>`;
            });
            tbody.innerHTML=html;
        }
        let timer=null;
        function toggleAuto() {
            const btn=document.getElementById('auto-btn');
            if(timer){ clearInterval(timer); timer=null; btn.innerText="âš¡ è‡ªåŠ¨åˆ·æ–°: å…³"; btn.className="btn-auto"; }
            else{ fetchLogs(); timer=setInterval(fetchLogs,2000); btn.innerText="âš¡ è‡ªåŠ¨åˆ·æ–°: å¼€"; btn.className="btn-refresh pulse"; }
        }
        async function clearLogs() { if(confirm('æ¸…ç©ºï¼Ÿ')) { await fetch(`${API}/clear`, { method: 'POST' }); fetchLogs(); } }
        fetchLogs();
    </script>
</body>
</html>