<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        body { background: #2c3e50; color: #ecf0f1; font-family: 'Consolas', 'å¾®è½¯é›…é»‘', monospace; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #34495e; padding-bottom: 10px; }
        h1 { font-size: 24px; color: #3498db; }
        
        .status-card { background: #34495e; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; gap: 20px; }
        .stat-item { flex: 1; text-align: center; border-right: 1px solid #7f8c8d; }
        .stat-item:last-child { border: none; }
        .stat-num { font-size: 28px; color: #e74c3c; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; background: #34495e; border-radius: 5px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #2c3e50; }
        th { background: #2980b9; color: white; }
        tr:hover { background: #3e5871; }
        
        .tag { padding: 3px 8px; border-radius: 3px; font-size: 12px; }
        .tag-buy { background: #e74c3c; color: white; } /* çº¢è‰²ä»£è¡¨è´­ä¹° */
        .tag-view { background: #27ae60; color: white; } /* ç»¿è‰²ä»£è¡¨æµè§ˆ */
        
        .controls { text-align: right; margin-bottom: 10px; }
        button { padding: 8px 15px; background: #e67e22; border: none; color: white; cursor: pointer; border-radius: 3px; }
        button:hover { background: #d35400; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ å•†åŸå®æ—¶ç›‘æ§ä¸­å¿ƒ</h1>
            <div style="font-size: 14px; color: #95a5a6;">æ•°æ®å®æ—¶åŒæ­¥ä¸­... <span id="clock"></span></div>
        </div>

        <!-- ç®€å•çš„æ•°æ®ç»Ÿè®¡ -->
        <div class="status-card">
            <div class="stat-item">
                <div class="stat-num" id="total-logs">0</div>
                <div>æ€»æ•è·è¡Œä¸º</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="active-users">0</div>
                <div>æ´»è·ƒç”¨æˆ·æ•°</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="fetchLogs()">ğŸ”„ ç«‹å³åˆ·æ–°</button>
        </div>

        <!-- ç›‘æ§è¡¨æ ¼ -->
        <table>
            <thead>
                <tr>
                    <th width="20%">æ—¶é—´</th>
                    <th width="15%">ç”¨æˆ·/IP</th>
                    <th width="15%">è¡Œä¸ºç±»å‹</th>
                    <th>äº¤äº’å¯¹è±¡ (å•†å“)</th>
                </tr>
            </thead>
            <tbody id="log-table">
                <!-- æ•°æ®ä¼šç”±JSå¡«å…… -->
            </tbody>
        </table>
    </div>

    <script>
        const API_BASE = ''; // è‡ªåŠ¨é€‚é…äº‘ç«¯åœ°å€

        // é¡µé¢å¯åŠ¨
        window.onload = function() {
            fetchLogs();
            // æ¯2ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡æ•°æ®ï¼Œå®ç°â€œå®æ—¶â€æ•ˆæœ
            setInterval(fetchLogs, 2000);
            setInterval(updateClock, 1000);
        };

        async function fetchLogs() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/logs`);
                const logs = await res.json();
                renderTable(logs);
                updateStats(logs);
            } catch (err) {
                console.error("è·å–æ—¥å¿—å¤±è´¥", err);
            }
        }

        function renderTable(logs) {
            const tbody = document.getElementById('log-table');
            tbody.innerHTML = '';

            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">æš‚æ— ç”¨æˆ·è¡Œä¸º...</td></tr>';
                return;
            }

            logs.forEach(log => {
                let tagClass = 'tag-view';
                if (log.action.includes('è´­ä¹°')) tagClass = 'tag-buy';

                const row = `
                    <tr>
                        <td>${log.time}</td>
                        <td>
                            <strong>${log.username}</strong><br>
                            <span style="font-size:12px; color:#95a5a6;">${log.ip || ''}</span>
                        </td>
                        <td><span class="tag ${tagClass}">${log.action}</span></td>
                        <td>${log.product}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateStats(logs) {
            document.getElementById('total-logs').innerText = logs.length;
            // ç®€å•çš„å»é‡è®¡ç®—æ´»è·ƒç”¨æˆ·
            const uniqueUsers = new Set(logs.map(l => l.username)).size;
            document.getElementById('active-users').innerText = uniqueUsers;
        }

        async function clearLogs() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç›‘æ§è®°å½•å—ï¼Ÿ')) {
                await fetch(`${API_BASE}/api/admin/clear`, { method: 'POST' });
                fetchLogs();
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
        }
    </script>
</body>
</html>
