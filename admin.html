// 引入必要的模块
const express = require('express');
const { createClient } = require('@supabase/supabase-js');
const path = require('path');

// 初始化Express应用
const app = express();
app.use(express.json());

// 配置静态文件服务，托管前端页面（包括数据驾驶舱的HTML）
app.use(express.static(path.join(__dirname, '.')));

// ====================== 替换成你自己的Supabase信息 ======================
const SUPABASE_URL = 'https://fulyzmmwivpwrvfoifdy.supabase.co'; // 你的Supabase URL
const SUPABASE_KEY = 'sb_publishable_miLBqFe78ez-ZTruWfF1Mw_C_fCC2Ui'; // 替换成自己的密钥
// =====================================================================

// 初始化Supabase客户端
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// 初始化：确保Supabase有logs表（首次运行自动创建，无需手动操作）
async function initSupabaseTable() {
  try {
    // 创建logs表：存储运营日志（时间、用户、行为、详情）
    await supabase.rpc('exec', {
      sql: `
        CREATE TABLE IF NOT EXISTS logs (
          id SERIAL PRIMARY KEY,
          time TEXT NOT NULL,
          user TEXT NOT NULL,
          action TEXT NOT NULL,
          detail TEXT NOT NULL
        );
      `
    });
    console.log('Supabase logs表初始化成功');
  } catch (err) {
    console.log('logs表初始化（已存在则忽略）：', err.message);
  }
}
initSupabaseTable();

// 1. 根路由：访问域名时返回数据驾驶舱页面（你提供的HTML）
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

// 2. 商品API接口（保留原有功能）
app.get('/api/products', async (req, res) => {
  try {
    const { data, error } = await supabase.from('products').select('*');
    if (error || !data || data.length === 0) {
      const demoProducts = [
        {"id":1,"name":"云端-高性能键盘","price":599,"desc":"数据存储在Supabase，永不丢失","img":"https://placehold.co/400x300/2c3e50/FFF?text=CloudKey"},
        {"id":2,"name":"云端-无线耳机","price":1299,"desc":"支持超长待机，数据云同步","img":"https://placehold.co/400x300/e74c3c/FFF?text=CloudAudio"},
        {"id":3,"name":"云端-电竞椅","price":899,"desc":"保护你的腰椎","img":"https://placehold.co/400x300/3498db/FFF?text=CloudChair"},
        {"id":4,"name":"云端-4K显示器","price":2499,"desc":"清晰度爆表","img":"https://placehold.co/400x300/9b8b-2f91c3c77f20?text=CloudScreen"}
      ];
      return res.json(demoProducts);
    }
    res.json(data);
  } catch (err) {
    res.status(500).json({ error: '获取商品数据失败' });
  }
});

// 3. 数据驾驶舱核心接口：获取日志列表
app.get('/logs', async (req, res) => {
  try {
    // 从Supabase获取日志，按ID倒序（最新的在前）
    const { data, error } = await supabase
      .from('logs')
      .select('*')
      .order('id', { ascending: false });
    
    if (error) throw error;
    // 如果没有日志，返回模拟数据让页面不空白
    if (!data || data.length === 0) {
      const mockLogs = [
        { time: new Date().toLocaleString(), user: '用户1001', action: '访问页面', detail: '访问商城首页' },
        { time: new Date().toLocaleString(), user: '用户1002', action: '加入购物车', detail: '加入云端-高性能键盘 ¥599' },
        { time: new Date().toLocaleString(), user: '用户1001', action: '访问页面', detail: '访问商品详情页（云端-无线耳机）' }
      ];
      return res.json(mockLogs);
    }
    res.json(data);
  } catch (err) {
    res.status(500).json({ error: '获取日志失败' });
  }
});

// 4. 数据驾驶舱核心接口：清空日志
app.post('/clear', async (req, res) => {
  try {
    const { error } = await supabase.from('logs').delete().neq('id', 0); // 删除所有日志
    if (error) throw error;
    res.json({ success: true });
  } catch (err) {
    res.status(500).json({ error: '清空日志失败' });
  }
});

// 配置端口（Render自动分配）
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});

